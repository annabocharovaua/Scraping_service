# -*- coding: utf-8 -*-
"""JobHuntHelper.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fRXwhZPQ85BIyXtEQJKq5KGeK7UnnLet
"""

!pip install telebot > null
!pip install selenium > null
!apt-get update > null
!apt-get install -y chromium-chromedriver > null
!pip install mysql-connector-python > null
!pip install schedule > null
!pip install config > null

import telebot
import mysql.connector
import requests
import codecs
import re
import time
import schedule
import threading
import config

from telebot import types
from enum import Enum
from urllib.parse import urlencode
from selenium import webdriver
from threading import Lock
from urllib.parse import urlencode, quote
from bs4 import BeautifulSoup as BS
from random import randint
from urllib.parse import urlencode

from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.webdriver.common.action_chains import ActionChains
from itertools import chain

from telebot.apihelper import ApiTelegramException
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
from datetime import datetime
from dateutil.relativedelta import relativedelta

class DatabaseManager:
    def __init__(self, config):
        self.config = config
        self.connection_pool = mysql.connector.pooling.MySQLConnectionPool(
            pool_name="my_pool",
            pool_size=5,
            **config
        )
        self.query_lock = Lock()

    def get_connection(self):
        return self.connection_pool.get_connection()

    def execute_query(self, query, params=None):
       with self.query_lock:
          connection = self.get_connection()
          cursor = connection.cursor()
          try:
              if params:
                  cursor.execute(query, params)
              else:
                  cursor.execute(query)

              # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (SELECT), –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
              if query.strip().upper().startswith('SELECT'):
                  results = cursor.fetchall()
              else:
                  # –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã–µ (INSERT, UPDATE, DELETE), —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
                  connection.commit()
                  results = []

          except Exception as e:
              print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
              results = None

          cursor.close()
          connection.close()
          return results

    def get_requests_from_db(self):
        query = """
            SELECT * FROM requests
            """
        return db_manager.execute_query(query)
#db_manager = DatabaseManager(config)
#result = db_manager.execute_query("SELECT * FROM requests")
#print(result)

class EXPERIENCE(Enum):
  DEFAULT_VALUE = -2
  STUDENT = -1
  WITHOUT_EXPERIENCE = 0
  ONE_YEAR = 1
  TWO_YEAR = 2
  THREE_YEAR = 3
  FOUR_YEAR = 4
  FIVE_YEAR = 5

def build_url(base_url, **params):
  # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏, —è–∫—ñ –º–∞—é—Ç—å None –∞–±–æ –ø–æ—Ä–æ–∂–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
  filtered_params = {k: v for k, v in params.items() if v}
  query_string = urlencode(filtered_params)
  return f"{base_url}?{query_string}" if query_string else base_url

def build_url_djinni(**params):
  base_url = "https://djinni.co/jobs/"

  params["location"] = params["location"].lower()
  if params["location"] == "remote":
    params["employment"]="remote"
    del params["location"]

  if params["exp_level"] == EXPERIENCE.DEFAULT_VALUE.value or params["exp_level"] > EXPERIENCE.FIVE_YEAR.value:
     params["exp_level"] = ""
  else:
     params["exp_level"] = str(params["exp_level"]) + 'y'
  if params["exp_level"] == "0y":
     params["exp_level"] = "no_exp"

  params["exp_rank"] = params["exp_rank"].lower()
  return build_url(base_url, **params)

def build_url_workua(language='', city='', position='', min_salary=0, experience=EXPERIENCE.DEFAULT_VALUE.value, **params):
  base_url = "https://www.work.ua/jobs"
  if city:
    base_url += '-' + city
  if language:
    base_url += '-' + quote(language)
  if position:
    base_url += '+' + position
  base_url += '/'
  salaryidfrom=''
  if min_salary:
    if 3000 <= min_salary and min_salary < 5000:
      params["salaryfrom"] = 2
    elif 5000 <= min_salary and min_salary < 7000:
      params["salaryfrom"] = 3
    elif 7000 <= min_salary and min_salary < 10000:
      params["salaryfrom"] = 4
    elif 10000 <= min_salary and min_salary < 15000:
      params["salaryfrom"] = 5
    elif 15000 <= min_salary and min_salary < 20000:
      params["salaryfrom"] = 6
    elif 20000 <= min_salary and min_salary < 30000:
      params["salaryfrom"] = 7
    elif min_salary > 30000:
      params["salaryfrom"] = 8

  if experience == EXPERIENCE.WITHOUT_EXPERIENCE.value:
    params["experience"] = 1
  elif experience == EXPERIENCE.STUDENT.value:
    params["student"] = 1

  return build_url(base_url, **params)


def convert_uah_to_usd_for_djinni(uah_amount, exchange_rate):
  # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω—å –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è
  round_values = [1500, 2500, 3500, 4500, 5500, 6500, 7500, 8500]
  usd_amount = uah_amount / exchange_rate
  if (usd_amount < 1500):
    return ''
  rounded_down_value = max([value for value in round_values if value <= usd_amount], default=min(round_values))
  return rounded_down_value

def build_url_dou(**params):
  base_url = "https://jobs.dou.ua/vacancies/"
  if params["city"] == "remote":
      del params["city"]
      params["remote"] = 'remote'

  if params.get("position"):
      params["search"] += " " + params["position"]
      del params["position"]
  if params["exp"] == EXPERIENCE.STUDENT.value or params["exp"] == EXPERIENCE.WITHOUT_EXPERIENCE.value or params["exp"] == EXPERIENCE.ONE_YEAR.value:
     params["exp"] = "0-1"
  elif params["exp"] == EXPERIENCE.TWO_YEAR.value or params["exp"] == EXPERIENCE.THREE_YEAR.value:
     params["exp"] = "1-3"
  elif params["exp"] == EXPERIENCE.FOUR_YEAR.value or params["exp"] == EXPERIENCE.FIVE_YEAR.value:
     params["exp"] = "3-5"
  elif params["exp"] > EXPERIENCE.FIVE_YEAR.value:
     params["exp"] = "5plus"
  else:
    del params["exp"]

  return build_url(base_url, **params)

def build_url_robota(language='', city='', **params):
  base_url = "https://robota.ua/zapros/"
  if language:
      base_url += quote(language).lower()
  if params["position"]:
      base_url += '-' + params["position"].lower()
      del params["position"]
  base_url += '/'
  if city == "remote":
      params["scheduleIds"] = 3
  elif city:
      base_url += city.lower() + '/'

  if params["experience"] == EXPERIENCE.WITHOUT_EXPERIENCE.value:
     params["experienceType"] = "true"
  params["experience"] = ""

  return build_url(base_url, **params)


def build_url_jooble(**params):
  base_url = "https://ua.jooble.org/SearchResult"

  if params["workExp"] == EXPERIENCE.STUDENT.value or params["workExp"] == EXPERIENCE.WITHOUT_EXPERIENCE.value:
    params["workExp"] = 1
  else:
    params["workExp"] = ""

  if params["rgns"] == "remote":
    params["loc"]=2
    params["rgns"] = ""
  return build_url(base_url, **params)


url = build_url_robota(
    language="c++",
    city="kyiv",
    position="junior",
    salary=20340,
    experience=0
)
print(url)

url = build_url_workua(
    language="c++",
    city="kyiv",
    #position="junior",
    #min_salary=20340,
    #experience=0,
    days=122
)
print(url)


url = build_url_djinni(
    all_keywords="python",
    primary_keyword="c#",
    region="UKR",
    location="Kyiv",
    exp_level=-2,
    exp_rank="junior",
    salary=convert_uah_to_usd_for_djinni(20, 39.1),
    keywords="c++"
)
print(url)

url = build_url_dou(city="remote", search="c++", position="junior", exp=1) #–≤ –¥–æ—É –º–æ–∂–Ω–∞ —Å–∫—Ä–∞–ø–∏—Ç—å —ñ –ø–æ 0-1 —ñ –ø–æ 1-3
print(url)

jooble_url = build_url_jooble(date=3, #—â–æ–± –≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é –Ω–µ–¥—ñ–ª–ª—é
                              rgns="remote",
                              salaryMin="1000",
                              ukw="junior" + ' ' + "c++",
                              workExp=0
                              )
print(jooble_url)

__all__ = ('work', "robota", 'dou', 'djinni')

headers = [
    {'User-Agent': 'Mozilla/5.0 (Windows NT 5.1; rv:47.0) Gecko/20100101 Firefox/47.0',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'},
    {'User-Agent': 'Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'},
    {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; rv:53.0) Gecko/20100101 Firefox/53.0',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'}
    ]



def work(url, city=None, language=None):
    jobs = []
    errors = []
    domain = 'https://www.work.ua'
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_div = soup.find('div', id='pjax-job-list')
            if main_div:
                div_lst = main_div.find_all('div', attrs={'class': 'job-link'})
                # —ñ–≥–Ω–æ—Ä—É—î–º–æ –≤–∞–∫–∞–Ω—Å—ñ—ó –ø—ñ—Å–ª—è p –∑ —Ç–µ–∫—Å—Ç–æ–º –í–∞–∫–∞–Ω—Å—ñ—ó, –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ —ñ–∑ –∑–∞–ø–∏—Ç–æ–º ¬´python junior¬ª —É –ö–∏—î–≤—ñ
                # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–ø–∏—Å–∫—É –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥—ñ–≤—ñ–≤, —è–∫—ñ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –ø–µ—Ä–µ–¥ –≤–∫–∞–∑–∞–Ω–∏–º —Ç–µ–≥–æ–º <p>
                target_p = soup.find('p', class_='text-default-7 add-bottom')

                result_divs = []
                if target_p:
                  for div in target_p.find_all_previous('div', class_='job-link'):
                      result_divs.append(div)
                else:
                  result_divs = div_lst


                for div in result_divs:
                    title = div.find('h2')
                    href = title.a['href']
                    content = div.p.text
                    description = re.sub(r'\s+', ' ', content).strip()
                    img_div = div.find('div', class_ = 'add-bottom')

                    spans = div.find_all('span',  class_='strong-600')
                    salary = '0'
                    company = ''
                    if len(spans)==2:
                      salary = spans[0].text
                      company = spans[1].text
                    else:
                      company = spans[0].text

                    if img_div:
                      img_tag = img_div.find('img')
                      if img_tag:  # –Ø–∫—â–æ —Ç–µ–≥ <img> –ø—Ä–∏—Å—É—Ç–Ω—ñ–π
                          img_src = img_tag['src']
                      else:
                          img_src = 'https://st.work.ua/i/work-ua-knowledge-graph.jpg'

                    jobs.append({'title': title.text, 'img_source': img_src, 'url': domain + href,
                                 'description': description, 'company': company,
                                 'city_id': city, 'language_id': language,'salary': salary, 'site': "workua"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def dou_image(url):
    image_src = ''
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            comp_div = soup.find('div', attrs={'class': 'b-compinfo'})
            if comp_div:
                a = comp_div.find('a', attrs={'class': 'logo'})
                image_src = a.img['src']

    return image_src


def dou(url, city=None, language=None):
    jobs = []
    errors = []

    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_div = soup.find('div', id='vacancyListId')
            if main_div:
                li_lst = main_div.find_all('li', attrs={'class': 'l-vacancy'})
                for li in li_lst:
                    title = li.find('div', attrs={'class': 'title'})
                    href = title.a['href']
                    cont = li.find('div', attrs={'class': 'sh-info'})
                    content = cont.text
                    company = 'No name'
                    salary = '0'
                    a = title.find('a', attrs={'class': 'company'})
                    img_src = dou_image(href)
                    if a:
                        company = a.text
                    jobs.append({'title': title.text, 'img_source': img_src, 'url': href,
                                 'description': content, 'company': company,
                                 'city_id': city, 'language_id': language, 'salary': salary, 'site': "dou"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def djinni(url, city=None, language=None):
    jobs = []
    errors = []
    domain = 'https://djinni.co'
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_ul = soup.find('ul',  attrs={'class': 'list-unstyled list-jobs mb-4'})
            if main_ul:
                li_lst = main_ul.find_all('li',
                                          attrs={'class': 'list-jobs__item'})
                for li in li_lst:
                    title_div = li.find('div',
                                    attrs={'class': 'job-list-item__title'})
                    if title_div:
                        title = title_div.a
                        href = title['href']

                    else:
                        print("Div –∑ –∫–ª–∞—Å–æ–º 'job-list-item__title' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")

                    cont = li.find('div', attrs={'class': 'job-list-item__description'})
                    span = cont.find('span')
                    content = span.text
                    company = 'No name'
                    span_salary = li.find('span', attrs={'class': 'public-salary-item'})
                    if span_salary:
                        salary = span_salary.text
                    else:
                        salary='0'
                    comp = li.find('a', attrs={'class': 'mr-2'})

                    img_div = li.find('div', attrs={'class': 'userpic-wrapper userpic-color_2 userpic_xs userpic-transparent userpic--logo'})
                    if img_div:
                        img_src = img_div.img['src']
                    else:
                        img_src = 'https://sourcingsummit.net/sosutech/wp-content/uploads/sites/30/2017/07/djinnix505x235-1.jpg'

                    if comp:
                        company = comp.text

                    jobs.append({'title': title.text, 'img_source': img_src, 'url': domain+href,
                                 'description': content, 'company': company,
                                 'city_id': city, 'language_id': language, 'salary': salary, 'site': "djinni"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def helper_robota(url):
    jobs = []
    errors = []
    domain = 'https://djinni.co'
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_ul = soup.find('ul',  attrs={'class': 'list-unstyled list-jobs mb-4'})
            if main_ul:
                li_lst = main_ul.find_all('li',
                                          attrs={'class': 'list-jobs__item'})
                for li in li_lst:
                    title_div = li.find('div',
                                    attrs={'class': 'job-list-item__title'})
                    if title_div:
                        title = title_div.a
                        href = title['href']

                    else:
                        print("Div –∑ –∫–ª–∞—Å–æ–º 'job-list-item__title' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")

                    cont = li.find('div', attrs={'class': 'job-list-item__description'})
                    span = cont.find('span')
                    content = span.text
                    company = 'No name'
                    span_salary = li.find('span', attrs={'class': 'public-salary-item'})
                    if span_salary:
                        salary = span_salary.text
                    else:
                        salary='0'
                    comp = li.find('a', attrs={'class': 'mr-2'})

                    img_div = li.find('div', attrs={'class': 'userpic-wrapper userpic-color_2 userpic_xs userpic-transparent userpic--logo'})
                    if img_div:
                        img_src = img_div.img['src']
                    else:
                        img_src = 'https://sourcingsummit.net/sosutech/wp-content/uploads/sites/30/2017/07/djinnix505x235-1.jpg'

                    if comp:
                        company = comp.text

                    jobs.append({'title': title.text, 'img_source': img_src, 'url': domain+href,
                                 'description': content, 'company': company,
                                 'salary': salary, 'site': "robota"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def robota(url, city=None, language=None):
    jobs = []
    errors = []
    domain = 'https://robota.ua'

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä–∞–π–≤–µ—Ä–∞ Chrome
    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument('--headless')
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.binary_location = 'chromedriver.exe'
    driver = webdriver.Chrome(options=chrome_options)

    try:
        driver.get(url)

        for i in range(10):
          driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
          time.sleep(2)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞–º–∏

        # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –≤–º—ñ—Å—Ç—É
        time.sleep(5)

        # –û—Ç—Ä–∏–º–∞–Ω–Ω—è HTML-–≤–º—ñ—Å—Ç—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        page_source = driver.page_source


        soup = BS(page_source, 'html.parser')

        # –ü–æ–∏—Å–∫ –±–ª–æ–∫–æ–≤ —Å –≤–∞–∫–∞–Ω—Å–∏—è–º–∏
        job_divs = soup.find_all('alliance-vacancy-card-desktop')
        for job_div in job_divs:
            #print(job_div)
            a = job_div.find('a', class_='card')
            if a:
                href = a['href']
            else:
                href = ''

            title_tag = job_div.find('h2', class_='santa-typo-h3')
            if title_tag:
                title = title_tag.text.strip()
            else:
                title = ''

            spans = job_div.find_all('span', class_='ng-trigger')
            salary = '0'
            company = ''
            for span in spans:
                text = span.text.strip()
                if '‚Ç¥' in text:  # –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∑–∞—Ä–ø–ª–∞—Ç–∞
                    salary = text
                else:
                    company = text
                    break
            # –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ —Ä–∞–±–æ—Ç–∞
            img_div = job_div.find('div', attrs={'class': 'company-logo'})
            img_src = 'https://play-lh.googleusercontent.com/mr-SZKDW5xmXOinA1cQWz6VeQ10BMKS_UfjGpSxrtoRAl9tNe6HPq5ALFCBAQE2Gw8A'
            if img_div:
                img_tag = img_div.find('img')
                if img_tag:
                    img_src = img_tag['src']

            content_divs = job_div.find_all('div', attrs={'class': 'badge'})
            content = ''
            if content_divs:
                for div in content_divs :
                    content += div.text + "."
                content += ".."
            if robota_help(driver, domain + href, language):
                jobs.append({'title': title, 'img_source': img_src, 'url': domain + href,
                            'description': content, 'company': company,
                            'city_id': city, 'language_id': language, 'salary': salary, 'site': "robota"})

    except Exception as e:
        errors.append({'url': url, 'title': str(e)})

    finally:
        # –ó–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        driver.quit()

    return jobs, errors

# url = 'https://robota.ua/zapros/java-junior/kyiv'
# print(url)
# jobs, errors = robota(url)
# print(jobs)
# print(errors)

def robota_help(driver, url, language):
    driver.get(url)
    # –û—Ç—Ä–∏–º–∞–Ω–Ω—è HTML-–≤–º—ñ—Å—Ç—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    page_source = driver.page_source
    #print(page_source)

    soup = BS(page_source, 'html.parser')
    description = soup.find('div', class_='full-desc')
    if description:
        return contains_language(description.get_text(), language)
    else:
        return False

def contains_language(description, language):
    return language.lower() in description.lower()

robota(url="https://robota.ua/ru/zapros/c%2523/kyiv?position=junior&experience=1", city="Kyiv", language="C#")

def jooble(url, language=None):
    jobs = []
    errors = []
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_div = soup.find('div', class_='infinite-scroll-component ZbPfXY _serpContentBlock')
            if main_div:
                div_lst = main_div.find_all('div', attrs={'data-test-name': '_jobCard'})

                for div in div_lst:
                    a = div.find('a', class_='hyperlink_appearance_undefined')
                    href = a['href']
                    title = a.text
                    div_info = div.find('div', class_='slQ-DR')
                    salary = '0'
                    p_salary = div_info.find('p')
                    if p_salary:
                        salary = p_salary.text
                    description = div_info('div', class_='PAM72f')
                    div_title = div.find('div', class_='L4BhzZ')
                    p_company = div_title.find('p', class_='z6WlhX')
                    company=''
                    if p_company:
                        company = p_company.text
                    img = div_title.find('img')
                    if img:
                        img_src = img['src']
                    else:
                        img_src =  'https://play-lh.googleusercontent.com/JCQ1opom-Kay8f3xVs9VfKmDKsKD3md5uKLJf93gsYAawE6UpzgN_2fALgS0mKOcNw=s256-rw'
                    #print(jooble_help(href, language))
                    jobs.append({'title': title, 'img_source': img_src, 'url': href,
                                'description': description[0].text, 'company': company,
                                  'salary': salary, 'site': "jooble"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

# def jooble_help(url, language):
#     print(url)
#     resp = requests.get(url, headers=headers[randint(0, 2)])
#     print(resp)
#     if resp.status_code == 200:
#         soup = BS(resp.content, 'html.parser')
#         description = soup.find('div', class_='GDU7fA')
#         print("description", description)
#         if description:
#             return contains_language(description.get_text(), language)
#     else:
#         print(resp.content.decode())
#         return False

# jooble("https://ua.jooble.org/SearchResult?ukw=c%2B%2B", language="C++")

def format_vacancy(job):
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –≤–∞–∫–∞–Ω—Å–∏–∏
    vacancy_message = f"üíº <b>{job['title'].strip()}</b>\n\n"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
    if 'company' in job and job['company'].strip():
        vacancy_message += f"üè¢ <b>–ö–æ–º–ø–∞–Ω—ñ—è:</b> {job['company'].strip()}\n\n"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞—è –∏ –Ω–µ —Ä–∞–≤–Ω–∞ '0'
    salary = job.get('salary', '')
    if salary and salary not in ['0', '']:
        vacancy_message += f"üíµ <b>–ó–∞—Ä–ø–ª–∞—Ç–∞:</b> {salary}\n\n"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏
    description = job.get('description', '')
    if description.strip():
        vacancy_message += f"üìù <b>–û–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó:</b>\n{description.strip()}\n\n"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–Ω–æ–ø–∫–µ
    vacancy_message += "<i>–©–æ–± –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ –æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ –≤–∞–∫–∞–Ω—Å—ñ—î—é, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ:</i>"

    site = job.get('site', '')
    if site == 'workua':
        button_text = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –Ω–∞ Work.ua"
    elif site == 'robota':
        button_text = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –Ω–∞ Robota"
    elif site == 'djinni':
        button_text = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –Ω–∞ Djinni"
    elif site == 'jooble':
        button_text = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –Ω–∞ Jooble"
    elif site == 'dou':
        button_text = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –Ω–∞ DOU"
    else:
        button_text = "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏"

    button = types.InlineKeyboardButton(text=button_text, url=job['url'])
    markup = types.InlineKeyboardMarkup().add(button)

    return vacancy_message, markup

def format_unique_vacancy(job):
    info = f"<b>{job['title']}</b>\n"
    if job['company']: info += f"<b>–ö–æ–º–ø–∞–Ω—ñ—è:</b> {job['company']}\n"
    info += f"<b>–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—è:</b> {job['technology']}\n"
    if job['position']: info += f"<b>–ü–æ–∑–∏—Ü—ñ—è:</b> {job['position']}\n"
    if job['city']: info += f"<b>–ú—ñ—Å—Ç–æ:</b> {job['city']}\n"

    if job['salary'] > 0:
        info += f"<b>–ó–∞—Ä–æ–±—ñ—Ç–Ω–∞ –ø–ª–∞—Ç–∞:</b> {job['salary']} –≥—Ä–Ω\n"
    else:
        info += "<b>–ó–∞—Ä–æ–±—ñ—Ç–Ω–∞ –ø–ª–∞—Ç–∞:</b> –Ω–µ –≤–∫–∞–∑–∞–Ω–æ\n"

    if job['description']:
        info += f"<b>–û–ø–∏—Å:</b> {job['description']}\n"

    if job['contact']:
        info += f"<b>–ö–æ–Ω—Ç–∞–∫—Ç:</b> {job['contact']}\n"
    return info

def send_job_offer_instructions(self, chat_id):
    instructions = """
    –ù–∞—à –±–æ—Ç –Ω–∞–¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–æ–¥–∞–≤—Ü—è–º –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Å–≤–æ—ó —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –≤–∞–∫–∞–Ω—Å—ñ—ó. –í–∞—à–∞ –≤–∞–∫–∞–Ω—Å—ñ—è –±—É–¥–µ –ø–æ–∑–Ω–∞—á–µ–Ω–∞ —è–∫ —É–Ω—ñ–∫–∞–ª—å–Ω–∞ —ñ –º–∞—Ç–∏–º–µ –¥–æ–¥–∞—Ç–∫–æ–≤—É –≤–∏–¥–∏–º—ñ—Å—Ç—å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

    <b>–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è:</b>
    - üìå –ù–∞–∑–≤–∞ –≤–∞–∫–∞–Ω—Å—ñ—ó
    - üìÇ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
    - üìû –ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –∑–≤'—è–∑–∫—É

    <b>–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è:</b>
    - üìù –û–ø–∏—Å
    - üí∞ –ó–∞—Ä–æ–±—ñ—Ç–Ω–∞ –ø–ª–∞—Ç–∞
    - üëî –ù–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏

    –í–∞—à–∞ –≤–∞–∫–∞–Ω—Å—ñ—è –±—É–¥–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏—Å—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –ø—Ä–æ—Ç—è–≥–æ–º 14 –¥–Ω—ñ–≤. –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ —ó—ó –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ. –í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤–∞–∫–∞–Ω—Å—ñ—é —É –±—É–¥—å-—è–∫–∏–π –º–æ–º–µ–Ω—Ç.

    –ü—ñ—Å–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è, –º–µ–Ω–µ–¥–∂–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∞–∫–∞–Ω—Å—ñ—é –∞–±–æ –≤—ñ–¥—Ö–∏–ª–∏—Ç—å —ó—ó —ñ–∑ –∑–∞–∑–Ω–∞—á–µ–Ω–Ω—è–º –ø—Ä–∏—á–∏–Ω–∏.
    """
    self.bot.send_message(chat_id, instructions, parse_mode="HTML")

class STAGE(Enum):
  START = 0
  NEXT_PARAM_CITY = 1
  NEXT_PARAM_CATEGORY = 2
  NEXT_PARAM_POSITION = 3
  NEXT_PARAM_MIN_SALARY = 4
  NEXT_PARAM_EXPERIENCE = 5
  NEXT_PARAM_LANGUAGE = 6
  END_OF_PROFILE_FILLING = 7
  RECEIVING_VACANCIES = 8
  START_SEARCH = 9
  START_SEARCHING_FOR_NEW_VACANCIES = 10
  CREATE_REQUEST = 11
  MY_REQUESTS = 12
  PRICING = 13
  ABOUT_BOT = 14
  CONTACTS = 15
  CREATE_UNIQUE_VACANCY = 16
  CREATE_UV_ADD_JOB_TITLE = 17
  CREATE_UV_ADD_CATEGORY = 18
  CREATE_UV_NEXT_PARAM_CATEGORY = 19
  CREATE_UV_ADD_COMPANY_NAME = 20
  CREATE_UV_ADD_DESCRIPTION = 21
  CREATE_UV_ADD_SALARY = 22
  CREATE_UV_ADD_EXPERIENCE = 23
  CREATE_UV_ADD_CITY = 24
  CREATE_UV_ADD_CONTACT = 25
  CREATE_UV_ADD_POSITION = 26

class Request:
  def __init__(self, language='', city='', position='', min_salary=0, experience=EXPERIENCE.DEFAULT_VALUE.value):
    self.language = language
    self.city = city
    self.position = position
    self.min_salary = int(min_salary)
    self.experience = int(experience)

  def __str__(self):
    return (f"Request(Language: {self.language}, City: {self.city}, "
            f"Position: {self.position}, Min Salary: {self.min_salary}, "
            f"Experience: {self.experience})")

  def set_language(self, language):
    self.language = language

  def set_city(self, city):
    self.city = city

  def set_position(self, position):
    self.position = position

  def set_min_salary(self, min_salary):
    self.min_salary = int(min_salary)

  def set_experience(self, experience):
    self.experience = int(experience)


  def add_request_to_db(self, chat_id, db_manager):
    existing_request = db_manager.execute_query("SELECT * FROM requests WHERE chat_id = %s AND technology = %s AND position = %s AND city = %s AND min_salary = %s AND experience = %s", (chat_id, self.language, self.position, self.city, self.min_salary, self.experience))
    if not existing_request:
                db_manager.execute_query(f"UPDATE users SET num_of_used_request = num_of_used_request + 1 WHERE chat_id = {chat_id}")
                db_manager.execute_query("INSERT INTO requests (chat_id, technology, position, city, min_salary, experience) VALUES (%s, %s, %s, %s, %s, %s)", (chat_id, self.language, self.position, self.city, self.min_salary, self.experience))
    else:
      return False
    return True

def submit_vacancy(jobs, chat_id, is_unique_vacancy = False):
  for job in jobs:
    print(job)
    try:
        #print("job['img_source'] = ", job['img_source'])
        if is_unique_vacancy:
          caption_ = format_unique_vacancy(job)
          bot.send_photo(chat_id, job['img_source'], caption=caption_, parse_mode='HTML')
        else:
          caption_, markup_ = format_vacancy(job)
          bot.send_photo(chat_id, job['img_source'], caption=caption_, reply_markup=markup_, parse_mode='HTML')
    except ApiTelegramException as e:
        print(f"An error occurred while sending the photo: {e}. URL: {job['img_source']}. Skip vacancy.")

def start_seach_and_send_unique_vacancy(request:Request, chat_id, on_the_background:bool = False):
    unique_vacancies = get_unique_vacancies_from_db(request)
    print(unique_vacancies)
    if not on_the_background:
        add_vacancies_to_db(request, chat_id, unique_vacancies, "unique")
        submit_vacancy(unique_vacancies, chat_id, is_unique_vacancy = True)
    else:
      return unique_vacancies

def start_seach_and_send_workua_vacancy(request:Request, chat_id, on_the_background:bool = False):
    if not on_the_background: days = 125 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å
    else: days = 122 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å
    url_work = build_url_workua(
            language=request.language,
            city=request.city, #–¢–£–¢ –ü–û–•–û–î–£ –£–ö–†–ê–á–ù–°–¨–ö–û–Æ –ù–ï –ú–û–ñ–ù–ê, –¢–†–ï–ë–ê –í–ò–ü–†–ê–í–ò–¢–ò
            position=request.position,
            min_salary=request.min_salary,
            experience=request.experience,
            days=days
    )
    print("WORKUA URL: ", url_work)
    jobs_work, errors_work = work(url_work)
    print(jobs_work)
    print(errors_work)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_work, "workua")
      submit_vacancy(jobs_work, chat_id)
    else:
      return jobs_work, errors_work

def start_seach_and_send_dou_vacancy(request:Request, chat_id, on_the_background:bool = False):
    url_dou = build_url_dou(search=request.language, position=request.position, city=request.city, exp=request.experience ) #–≤ –¥–æ—É –º–æ–∂–Ω–∞ —Å–∫—Ä–∞–ø–∏—Ç—å —ñ –ø–æ 0-1 —ñ –ø–æ 1-3, —Ç–æ–∂–µ –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É
    print("DOU URL: ", url_dou)
    jobs_dou, errors_dou = dou(url_dou)
    print(jobs_dou)
    print(errors_dou)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_dou, "dou")
      submit_vacancy(jobs_dou, chat_id)
    else:
      return jobs_dou, errors_dou

def start_seach_and_send_djinni_vacancy(request:Request, chat_id, on_the_background:bool = False):
    url_djinni = build_url_djinni(
      #all_keywords=request.language,
      primary_keyword=request.language,
      region="UKR",
      location=request.city,
      exp_level=request.experience,
      exp_rank=request.position,
      salary=convert_uah_to_usd_for_djinni(request.min_salary, 39.1),
      keywords=request.language
    )
    print("DJINNI URL: ", url_djinni)
    jobs_djinni, errors_djinni = djinni(url_djinni)
    add_vacancies_to_db(request, chat_id, jobs_djinni, "djinni")
    print(jobs_djinni)
    print(errors_djinni)
    if not on_the_background:
      submit_vacancy(jobs_djinni, chat_id)
    else:
      return jobs_djinni, errors_djinni

def start_seach_and_send_robota_vacancy(request:Request, chat_id, on_the_background:bool = False):
    url_robota=build_url_robota(language=request.language, city=request.city, position=request.position, salary = request.min_salary, experience=request.experience)
    print("ROBOTA URL: ", url_robota)
    jobs_rabota, errors_robota = robota(url_robota, language=request.language)
    print(jobs_rabota)
    print(errors_robota)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_rabota, "robota")
      submit_vacancy(jobs_rabota, chat_id)
    else:
      return jobs_rabota, errors_robota

def start_seach_and_send_jooble_vacancy(request:Request, chat_id, on_the_background:bool = False):
    if not on_the_background: date = 3 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é –Ω–µ–¥—ñ–ª–ª—é
    else: date = 8 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å
    url_jooble = build_url_jooble(date=date,
                                  rgns=request.city,
                                  salaryMin=request.min_salary,
                                  ukw=request.position + ' ' + request.language,
                                  workExp=request.experience
                                 )
    print("JOOBLE URL: ", url_jooble)
    jobs_jooble, errors_jooble = jooble(url_jooble)
    print(jobs_jooble)
    print(errors_jooble)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_jooble, "jooble")
      submit_vacancy(jobs_jooble, chat_id)
    else:
      return jobs_jooble, errors_jooble

def check_db_has_such_vacancy(request_id, site, title, company):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –≤–∞–∫–∞–Ω—Å–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    check_query = """
        SELECT COUNT(*) FROM vacancies
        WHERE request_id = %s AND site = %s AND title = %s AND company = %s
        """
    check_params = (request_id, site, title, company)
    check_result = db_manager.execute_query(check_query, check_params)
    if check_result[0][0] == 0:
      return False
    else:
      return True

def add_NEW_vacancy_to_db(request_id, site, title, company, description):
    insert_query = """
                    INSERT INTO vacancies (request_id, site, title, company, description) VALUES(%s, %s, %s, %s, %s)
                    """
    insert_params = (request_id, site, title, company, description)
    insert_result = db_manager.execute_query(insert_query, insert_params)
    return insert_result

def add_vacancies_to_db(request: Request, chat_id, vacancies, site):
    query = """
        SELECT request_id FROM requests
        WHERE chat_id = %s AND technology = %s AND position = %s AND city = %s AND min_salary = %s AND experience = %s
        """
    params = (chat_id, request.language, request.position, request.city, request.min_salary, request.experience)
    result = db_manager.execute_query(query, params)

    if result:
        for vacancy in vacancies:#[:5]:  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –≤–∞–∫–∞–Ω—Å–∏–π. –ù–ï–¢. –ü–û–ö–ê –ß–¢–û –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –í–°–ï –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –¥–±, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ –±—ã–ª–æ –ø—Ä–æ–±–ª–µ–º
            db_has_such_vacancy = check_db_has_such_vacancy(result[0][0], site, vacancy['title'],  (vacancy['company'] or '').strip())
            # –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            if db_has_such_vacancy == False:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∞–∫–∞–Ω—Å–∏—è –≤ –±–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                insert_result = add_NEW_vacancy_to_db(result[0][0], site, vacancy['title'], (vacancy['company'] or '').strip(), vacancy.get('description', ''))
                print("–í–∞–∫–∞–Ω—Å–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞:", insert_result)
            else:
                print("–í–∞–∫–∞–Ω—Å–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")

def process_vacancy(vacancy, request_item, is_unique_vacancy = False):
  print("vacancy: ", vacancy)
  if check_db_has_such_vacancy(request_item[0], vacancy['site'], vacancy['title'], (vacancy['company'] or '').strip()) == False:
    print("Find new vacancy! Add to db and submit to chat")
    insert_result = add_NEW_vacancy_to_db(request_item[0], vacancy['site'], vacancy['title'], (vacancy['company'] or '').strip(), vacancy.get('description', ''))
    print("–í–∞–∫–∞–Ω—Å–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞:", insert_result)
    submit_vacancy([vacancy], int(request_item[1]), is_unique_vacancy) #request_item[1] - —Ü–µ chat_id
  else:
    print("This vacancy is already in the database")
    #bot.send_message(request_item[1], "Nothing new. I'm working...")

import schedule
import time

class JobScheduler:
    def __init__(self, db_manager):
        self.db_manager = db_manager
        self.keep_running = False

    def job(self):
        print("Start working on background")
        requests_from_db = self.db_manager.get_requests_from_db()
        for request_item in requests_from_db:
          request_from_db = Request(language=request_item[2], city=request_item[4], position=request_item[3], min_salary=request_item[5], experience=request_item[6])
          print(request_from_db)
          print("Start searching on background")
          unique_vacancies = start_seach_and_send_unique_vacancy(request_from_db, 0, on_the_background = True)
          jobs_work, errors_work = start_seach_and_send_workua_vacancy(request_from_db, 0, on_the_background = True)
          # jobs_dou, errors_dou = start_seach_and_send_dou_vacancy(request_from_db, 0, on_the_background = True)
          # jobs_djinni, errors_djinni = start_seach_and_send_djinni_vacancy(request_from_db, 0, on_the_background = True)
          # jobs_rabota, errors_robot = start_seach_and_send_robota_vacancy(request_from_db, 0, on_the_background = True)
          # jobs_jooble, errors_jooble = start_seach_and_send_jooble_vacancy(request_from_db, 0, on_the_background = True)
          print("End searching on background")

          vacancies = list(chain(jobs_work))#, jobs_dou, jobs_djinni, jobs_rabota, jobs_jooble))
          #vacancies = [jobs_work]#, jobs_dou, jobs_djinni, jobs_rabota, jobs_jooble]
          print("Start checking finding vacancies")
          for vacancy in unique_vacancies:
              process_vacancy(vacancy, request_item, is_unique_vacancy=True)
          for vacancy in vacancies:
              process_vacancy(vacancy, request_item)
          print("End checking finding vacancies")

    def start_scheduler(self):
        self.keep_running = True

    def stop_scheduler(self):
        self.keep_running = False

    def run_scheduler(self):
        schedule.every(1).minutes.do(self.job)
        print("start run_scheduler. keep_running = ", self.keep_running)
        while self.keep_running:
            schedule.run_pending()
            time.sleep(1)

def get_subscription_info(chat_id):
    result = db_manager.execute_query("SELECT paid_subscription FROM users WHERE chat_id = %s", (chat_id,))
    if result:
        subscription_level = result[0][0]
        if subscription_level == 0:
            return "–í–∏ —â–µ –Ω–µ –æ–±—Ä–∞–ª–∏ –∂–æ–¥–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ—É."
        elif subscription_level == 1:
            return "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: üî¥ –ï–∫–æ–Ω–æ–º."
        elif subscription_level == 2:
            return "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç."
        elif subscription_level == 3:
            return "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: üü¢ –ë—ñ–∑–Ω–µ—Å."
    else:
        return "–í–∏ —â–µ –Ω–µ –æ–±—Ä–∞–ª–∏ –∂–æ–¥–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ—É."

class UniqueVacancy:
    def __init__(self, title="", company="", category="", description="", salary=0, position="", experience=0, city="", contact="", status="active", photo=None):
        self.title = title
        self.company = company
        self.category = category
        self.description = description
        self.salary = salary
        self.position = position
        self.experience = experience
        self.city = city
        self.contact = contact
        self.status = status  # –ü–æ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—é –≤–∞–∫–∞–Ω—Å—ñ—è –∞–∫—Ç–∏–≤–Ω–∞
        self.photo = photo  # –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤–∞–∫–∞–Ω—Å—ñ—ó (—è–∫—â–æ —î)

    def set_title(self, title):
        if not title:
            raise ValueError("–ù–∞–∑–≤–∞ –≤–∞–∫–∞–Ω—Å—ñ—ó –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é.")
        self.title = title

    def set_company(self, company):
        self.company = company

    def set_category(self, category):
        self.category = category

    def set_description(self, description):
        self.description = description

    def set_position(self, position):
        self.position = position

    def set_salary(self, salary):
        self.salary = salary

    def set_experience(self, experience):
        self.experience = experience

    def set_city(self, city):
        self.city = city

    def set_contact(self, contact):
        self.contact = contact

    def set_status(self, status):
        self.status = status

    def __str__(self):
        info = f"–ù–∞–∑–≤–∞ –≤–∞–∫–∞–Ω—Å—ñ—ó: {self.title}\n"
        info += f"–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó: {self.company}\n"
        info += f"–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: {self.category}\n"
        info += f"–û–ø–∏—Å: {self.description}\n"
        info += f"–ó–∞—Ä–æ–±—ñ—Ç–Ω—è –ø–ª–∞—Ç–∞: {self.salary}\n"
        info += f"–ü–æ–∑–∏—Ü—ñ—è: {self.position}\n"
        info += f"–î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏: {self.experience}\n"
        info += f"–ú—ñ—Å—Ç–æ: {self.city}\n"
        info += f"–ö–æ–Ω—Ç–∞–∫—Ç: {self.contact}\n"
        info += f"–°—Ç–∞—Ç—É—Å: {self.status}\n"
        if self.photo:
            info += "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è: –î–æ–¥–∞–Ω–æ\n"
        else:
            info += "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è: –ù–µ –¥–æ–¥–∞–Ω–æ\n"
        return info

    def to_dict(self):
        end_date = datetime.now().date() + relativedelta(days=14)
        return {
            "technology": self.category,
            "position": self.position,
            "city": self.city,
            "salary": self.salary,
            "experience": self.experience,
            "title": self.title,
            "company": self.company,
            "description": self.description,
            "contact": self.contact,
            "end_date": end_date
        }

    def add_unique_vacancy_to_db(self):
        insert_query = """
                        INSERT INTO unique_vacancies (technology, position, city, salary, experience, title, company, description, contacts, end_date)
                        VALUES(%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                        """
        end_date = datetime.now().date() + relativedelta(days=14)
        insert_params = (self.category, self.position, self.city, self.salary, self.experience, self.title, self.company, self.description, self.contact, end_date)
        insert_result = db_manager.execute_query(insert_query, insert_params)

        if not insert_result:
          select_query = """
                    SELECT vacancy_id
                    FROM unique_vacancies
                    WHERE title = %s AND technology = %s AND position = %s AND salary =  = %s AND description = %s
                    """
          select_params = (self.title, self.category, self.position, self.salary, self.description)
          return db_manager.execute_query(select_query, select_params)[0][0]
        return insert_result

def get_unique_vacancies_from_db(request):
  query = f"SELECT * FROM unique_vacancies \
            WHERE technology = '{request.language}' "
  if request.position : query+= f"and (position = '{request.position}' or position is null) "
  if request.city : query+= f"and (city = '{request.city}' or city is null) "
  if request.min_salary : query+= f"and (salary > {request.min_salary} or salary = 0) "
  if request.experience != EXPERIENCE.DEFAULT_VALUE.value : query+= f"and (experience = {request.experience} or experience = -2)";
  #print(query)
  result = db_manager.execute_query(query)
  print(result)
  formatted_vacancies = []
  for vacancy in result:
    #print(vacancy)
    vacancy_dict = {
            'technology': vacancy[1],
            'position': vacancy[2],
            'city': vacancy[3],
            'salary': vacancy[4],
            'experience': vacancy[5],
            'title': vacancy[6],
            'company': vacancy[7],
            'description': vacancy[8],
            'contact': vacancy[10],
            'img_source': vacancy[9],
            'site': "unique"
        }
    formatted_vacancies.append(vacancy_dict)
  return formatted_vacancies

class AdminManager:
    def __init__(self, db_manager):
        self.db_manager = db_manager

    def is_admin(self, chat_id):
        result = db_manager.execute_query(f"SELECT * FROM admins WHERE admin_id = {chat_id}")
        if not result:
          return False
        return True

    def get_main_admin_id(self):
        result = db_manager.execute_query("SELECT admin_id FROM admins")
        return result[0][0]

class UserManager:
    def __init__(self, db_manager):
        self.db_manager = db_manager

    def check_and_new_add_user_to_db(self, chat_id):
        result = db_manager.execute_query(f"SELECT * FROM users WHERE chat_id = {chat_id}")
        if not result:
          db_manager.execute_query(f"INSERT INTO users (chat_id, paid_subscription, max_num_of_request, num_of_used_request) VALUES ({chat_id}, 0, 2, 0);")

    def user_can_create_request(self, chat_id):
      user_info = db_manager.execute_query(f"SELECT num_of_used_request, max_num_of_request FROM users WHERE chat_id = {chat_id}")
      if user_info:
          num_of_used_request, max_num_of_request = user_info[0]
          if num_of_used_request >= max_num_of_request:
              return False
          else:
            return True
      return False

    def get_stage(self, chat_id):
        query = f"SELECT stage FROM users WHERE chat_id = '{chat_id}' "
        result = db_manager.execute_query(query)
        return result[0][0]

    def set_stage(self, chat_id, stage):
        result = db_manager.execute_query(f"UPDATE users SET stage = {stage} WHERE chat_id = {chat_id}")

# user_manager = UserManager(db_manager)
# print(user_manager.get_stage(535434829))
# user_manager.set_stage(535434829, 0)

class BotManager:
    def __init__(self, token, payments_token, db_manager, user_manager, admin_manager):
        self.bot = telebot.TeleBot(token)
        self.payments_token = payments_token
        self.db_manager = db_manager
        self.db_manager.execute_query("UPDATE users SET stage = 0")
        self.user_manager = user_manager
        self.admin_manager = admin_manager
        self.users_vacancies = {}
        self.users_requests = {}
        self.setup_handlers()

    def run(self):
        self.bot.polling(none_stop=True, interval=0)

    def setup_handlers(self):
        self.bot.message_handler(commands=['start'])(self.start)
        self.bot.message_handler(commands=['pay1'])(self.pay1_command)
        self.bot.message_handler(commands=['pay2'])(self.pay2_command)
        self.bot.message_handler(commands=['pay3'])(self.pay3_command)
        self.bot.message_handler(content_types=['text'])(self.handle_text)
        self.bot.callback_query_handler(func=lambda call: call.data.startswith('delete_request_'))(self.delete_request)
        self.bot.callback_query_handler(func=lambda call: call.data.startswith('delete_new_unique_vacancy_'))(self.delete_new_unique_vacancy)
        self.bot.callback_query_handler(func=lambda call: call.data.startswith('approve_new_unique_vacancy_'))(self.approve_new_unique_vacancy)
        self.bot.callback_query_handler(func=lambda call: call.data.startswith('delete_unique_vacancy_'))(self.delete_unique_vacancy)
        self.bot.pre_checkout_query_handler(func=lambda query: True)(self.pre_checkout_query)
        self.bot.message_handler(content_types=['successful_payment'])(self.successful_payment)

    def show_main_menu(self, user_id):
        markup = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)

        item1 = types.KeyboardButton("üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç")
        item2 = types.KeyboardButton("üìã –ú–æ—ó –∑–∞–ø–∏—Ç–∏")
        item3 = types.KeyboardButton("üí≥ –¢–∞—Ä–∏—Ñ–∏ —Ç–∞ –û–ø–ª–∞—Ç–∞")
        item4 = types.KeyboardButton("‚ÑπÔ∏è –ü—Ä–æ –±–æ—Ç")
        item5 = types.KeyboardButton("üíº –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –≤–∞–∫–∞–Ω—Å—ñ—é")
        item6 = types.KeyboardButton("üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏")

        markup.add(item1, item2, item3, item4, item5, item6)

        self.bot.send_message(user_id, "–û–±–µ—Ä—ñ—Ç—å –Ω–∞—Å—Ç—É–ø–Ω—É –¥—ñ—é:", reply_markup=markup)

    def show_create_UV_required_fields_menu(self, user_id):
        mandatory_markup = telebot.types.ReplyKeyboardMarkup(row_width=3, resize_keyboard=True, one_time_keyboard=True)

        item1 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –Ω–∞–∑–≤—É –≤–∞–∫–∞–Ω—Å—ñ—ó")
        item2 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é")
        item3 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –∑–≤'—è–∑–∫—É")
        item4 = telebot.types.KeyboardButton("‚¨ÖÔ∏è")
        item5 = telebot.types.KeyboardButton("‚û°Ô∏è")

        mandatory_markup.add(item1,item2, item3)
        mandatory_markup.add(item4, item5)

        # –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é
        self.bot.send_message(user_id, "–û–±–µ—Ä—ñ—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è:", reply_markup=mandatory_markup)

    def show_create_UV_optional_fields_menu(self, user_id):
        mandatory_markup = telebot.types.ReplyKeyboardMarkup(row_width=3, resize_keyboard=True, one_time_keyboard=True)

        item1 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –Ω–∞–∑–≤—É –∫–æ–º–ø–∞–Ω—ñ—ó")
        item2 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é")
        item3 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –æ–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó")
        item4 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –∑–∞—Ä–æ–±—ñ—Ç–Ω—é –ø–ª–∞—Ç—É")
        item5 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –º—ñ—Å—Ç–æ —Ä–æ–±–æ—Ç–∏")
        item6 = telebot.types.KeyboardButton("–î–æ–¥–∞—Ç–∏ –¥–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏")
        item7 = telebot.types.KeyboardButton("–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞–∑–∞–¥")
        item8 = telebot.types.KeyboardButton("‚úÖ–ì–æ—Ç–æ–≤–æ")

        mandatory_markup.add(item1, item2, item3, item4, item5, item6, item7, item8)

        self.bot.send_message(user_id, "–û–±–µ—Ä—ñ—Ç—å –Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è:",  reply_markup=mandatory_markup)

    def generate_keyboard(self, options, button_size):
       keyboard_rows = []
       for i in range(0, len(options), button_size):
            keyboard_rows.append(options[i:i + button_size])
       markup = ReplyKeyboardMarkup(row_width=button_size, resize_keyboard=True)
       for row in keyboard_rows:
            markup.row(*[KeyboardButton(option) for option in row])

       return markup

    def start(self, message):
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        # btn1 = types.KeyboardButton("–ü–æ—á–∞—Ç–∏ –ø–æ—à—É–∫ —Ä–æ–±–æ—Ç–∏")
        # markup.add(btn1)
        self.bot.send_message(message.from_user.id, "üëã –ü—Ä–∏–≤—ñ—Ç! –í–∞—Å –≤—ñ—Ç–∞—î –±–æ—Ç –∑ –ø–æ—à—É–∫—É —Ä–æ–±–æ—Ç–∏!", reply_markup=markup)
        self.show_main_menu(message.from_user.id)
        self.user_manager.set_stage(message.from_user.id, STAGE.START.value)


    def show_create_request_menu(self, user_id):
        self.bot.send_message(user_id, "–û–±–µ—Ä—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=self.generate_keyboard(["üìÇ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è", "üèô –ú—ñ—Å—Ç–æ", "üíº –ü–æ–∑–∏—Ü—ñ—è", "‚è≥ –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏", "üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞", "üîç –ü–æ—á–∞—Ç–∏ –ø–æ—à—É–∫!"], 2))

    def pre_checkout_query(self, pre_checkout_query):
        try:
           self.bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)
        except Exception as e:
            print(f"Error handling pre_checkout_query: {e}")

    def successful_payment(self, message):
        payment_info = message.successful_payment
        payment_details = (f"Chat id: {message.chat.id}\n"
                           f"Currency: {payment_info.currency}\n"
                           f"Total amount: {payment_info.total_amount / 100:.2f} {payment_info.currency}\n"
                           f"Invoice payload: {payment_info.invoice_payload}")
        print("SUCCESSFUL PAYMENT:", payment_details)
        self.bot.send_message(message.chat.id, f"–ü–ª–∞—Ç—ñ–∂ –Ω–∞ —Å—É–º—É {payment_info.total_amount / 100:.2f} {payment_info.currency} –ø—Ä–æ–π—à–æ–≤ —É—Å–ø—ñ—à–Ω–æ.")

        if payment_info.invoice_payload == "üî¥ –ï–∫–æ–Ω–æ–º":
            self.pay1_payment_end(message.chat.id)
        elif payment_info.invoice_payload == "üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç":
            self.pay2_payment_end(message.chat.id)
        elif payment_info.invoice_payload == "üü¢ –ë—ñ–∑–Ω–µ—Å":
            self.pay3_payment_end(message.chat.id)

    def pay1_command(self, message):
        prices = [types.LabeledPrice(label="üî¥ –ï–∫–æ–Ω–æ–º", amount=4000)]
        self.bot.send_invoice(
            chat_id=message.chat.id,
            title="üî¥ –ï–∫–æ–Ω–æ–º",
            description="""–°—Ç–≤–æ—Ä—é–π—Ç–µ –¥–æ –¥–≤–æ—Ö(2) –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å. \n–¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è. \n–û–ø–ª–∞—á—É—é—á–∏ –í–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –£–º–æ–≤–∞–º–∏ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è.""",
            provider_token=self.payments_token,
            currency='UAH',
            photo_url="https://www.aroged.com/wp-content/uploads/2022/06/Telegram-has-a-premium-subscription.jpg", # –§–æ—Ç–æ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏
            photo_width=416,
            photo_height=234,
            photo_size=416,
            is_flexible=False,
            prices=prices,
            max_tip_amount=20000,
            suggested_tip_amounts=[1000, 5000, 10000],
            start_parameter='time-machine-subs',
            invoice_payload='üî¥ –ï–∫–æ–Ω–æ–º'
        )

    def pay2_command(self, message):
        prices = [types.LabeledPrice(label="üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç", amount=8000)]
        self.bot.send_invoice(
            chat_id=message.chat.id,
            title="üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç",
            description="""–°—Ç–≤–æ—Ä—é–π—Ç–µ –¥–æ —á–æ—Ç–∏—Ä—å–æ—Ö(4) –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å. \n–¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è. \n–û–ø–ª–∞—á—É—é—á–∏ –í–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –£–º–æ–≤–∞–º–∏ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è.""",
            provider_token=self.payments_token,
            currency='UAH',
            photo_url="https://www.aroged.com/wp-content/uploads/2022/06/Telegram-has-a-premium-subscription.jpg", # –§–æ—Ç–æ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏
            photo_width=416,
            photo_height=234,
            photo_size=416,
            is_flexible=False,
            prices=prices,
            max_tip_amount=20000,
            suggested_tip_amounts=[1000, 5000, 10000],
            start_parameter='time-machine-subs',
            invoice_payload='üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç'
        )

    def pay3_command(self, message):
        prices = [types.LabeledPrice(label="üü¢ –ë—ñ–∑–Ω–µ—Å", amount=20000)]
        self.bot.send_invoice(
            chat_id=message.chat.id,
            title="üü¢ –ë—ñ–∑–Ω–µ—Å",
            description="""–°—Ç–≤–æ—Ä—é–π—Ç–µ –¥–æ –¥–µ—Å—è—Ç–∏(10) –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å. \n–¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è. \n–û–ø–ª–∞—á—É—é—á–∏ –í–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –£–º–æ–≤–∞–º–∏ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è.""",
            provider_token=self.payments_token,
            currency='UAH',
            photo_url="https://www.aroged.com/wp-content/uploads/2022/06/Telegram-has-a-premium-subscription.jpg", # –§–æ—Ç–æ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏
            photo_width=416,
            photo_height=234,
            photo_size=416,
            is_flexible=False,
            prices=prices,
            max_tip_amount=20000,
            suggested_tip_amounts=[1000, 5000, 10000],
            start_parameter='time-machine-subs',
            invoice_payload='üü¢ –ë—ñ–∑–Ω–µ—Å'
        )

    def pay1_payment_end(self, chat_id):
        end_date_subscription = get_end_subscription_date()
        self.db_manager.execute_query("UPDATE users SET paid_subscription = 1, max_num_of_request = 2, end_date_subscription = %s WHERE chat_id = %s", (end_date_subscription, chat_id))
        self.bot.send_message(chat_id, "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –ï–∫–æ–Ω–æ–º.")

    def pay2_payment_end(self, chat_id):
        end_date_subscription = get_end_subscription_date()
        self.db_manager.execute_query("UPDATE users SET paid_subscription = 2, max_num_of_request = 4, end_date_subscription = %s WHERE chat_id = %s", (end_date_subscription, chat_id))
        self.bot.send_message(chat_id, "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –°—Ç–∞–Ω–¥–∞—Ä—Ç.")

    def pay3_payment_end(self, chat_id):
        end_date_subscription = get_end_subscription_date()
        self.db_manager.execute_query("UPDATE users SET paid_subscription = 3, max_num_of_request = 10, end_date_subscription = %s WHERE chat_id = %s", (end_date_subscription, chat_id))
        self.bot.send_message(chat_id, "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –ë—ñ–∑–Ω–µ—Å.")

    def show_user_requests(self, chat_id):
        query = "SELECT * FROM requests WHERE chat_id = %s"
        params = (chat_id,)
        user_requests = self.db_manager.execute_query(query, params)

        if user_requests:
            for i, req in enumerate(user_requests, start=1):
                request_text = f"""
    <b>üîç –ù–æ–º–µ—Ä –∑–∞–ø–∏—Ç—É:</b> {i} \n
"""

                if req[2]:
                    request_text += f"<b>üìÇ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</b> {req[2]}\n"
                if req[3]:
                    request_text += f"<b>üíº –ü–æ–∑–∏—Ü—ñ—è:</b> {req[3]}\n"
                if req[4]:
                    request_text += f"<b>üèô –ú—ñ—Å—Ç–æ:</b> {req[4]}\n"
                if req[5] != 0:
                    request_text += f"<b>üí∞ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –∑–∞—Ä–æ–±—ñ—Ç–Ω–∞ –ø–ª–∞—Ç–∞:</b> {req[5]}\n"
                if req[6] != -2:
                    if req[6] == -1:
                        request_text += "<b>üïí –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏:</b> –°—Ç—É–¥–µ–Ω—Ç\n"
                    else:
                        request_text += f"<b>üïí –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏:</b> {req[6]} —Ä–æ–∫—ñ–≤\n"

                # –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ—è—Å–Ω–µ–Ω–Ω—è
                request_text += "\n<i>–Ø–∫—â–æ –≤–∏ –±–∞–∂–∞—î—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –∑–∞–ø–∏—Ç, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ.</i>\n"

                # –°—Ç–≤–æ—Ä—é—î–º–æ InlineKeyboardButton –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –∑ –∫–Ω–æ–ø–∫–æ—é "–í–∏–¥–∞–ª–∏—Ç–∏"
                button = types.InlineKeyboardButton(text="‚ùå –í–∏–¥–∞–ª–∏—Ç–∏", callback_data=f"delete_request_{req[0]}")
                markup = types.InlineKeyboardMarkup().add(button)
                self.bot.send_message(chat_id, request_text, reply_markup=markup, parse_mode="HTML")
        else:
             no_requests_text = """
                <b>–í–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–∏–ª–∏ –∂–æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É.</b> \n \n–î–ª—è —Ç–æ–≥–æ, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É <b>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç</b> –≤ –º–µ–Ω—é."""
             self.bot.send_message(chat_id, no_requests_text, parse_mode="HTML")

    def delete_request(self, call):
        request_id = int(call.data.split('_')[-1])
        self.db_manager.execute_query("UPDATE users SET num_of_used_request = num_of_used_request - 1 WHERE chat_id = %s", (call.from_user.id,))
        self.db_manager.execute_query("DELETE FROM requests WHERE request_id = %s", (request_id,))
        self.bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Ç –≤–∏–¥–∞–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ.")
        self.bot.delete_message(chat_id=call.from_user.id, message_id=call.message.message_id)

    def delete_unique_vacancy(self, call):
        unique_vacancy_id = int(call.data.split('_')[-1])
        print(unique_vacancy_id)

    def send_new_vacancy_to_admin(self, chat_id):
        button_delete = types.InlineKeyboardButton(text="–í–∏–¥–∞–ª–∏—Ç–∏", callback_data=f"delete_new_unique_vacancy_{chat_id}")
        button_approve = types.InlineKeyboardButton(text="–ó–∞—Ç–≤–µ—Ä–¥–∏—Ç–∏", callback_data=f"approve_new_unique_vacancy_{chat_id}")
        markup = types.InlineKeyboardMarkup().add(button_delete, button_approve)
        self.bot.send_message(self.admin_manager.get_main_admin_id(), self.users_vacancies.get(chat_id), reply_markup=markup)

    def delete_new_unique_vacancy(self, call):
        chat_id = int(call.data.split('_')[-1])
        self.bot.send_message(chat_id, "–ù–∞ –∂–∞–ª—å, –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å—ñ—è:\n\n" + str(self.users_vacancies.get(chat_id)) + "\n–ù–µ –ø—Ä–æ–π—à–ª–∞ –º–æ–¥–µ—Ä—É–≤–∞–Ω–Ω—è")
        del self.users_vacancies[chat_id]
        self.bot.edit_message_reply_markup(chat_id=self.admin_manager.get_main_admin_id(), message_id=call.message.message_id, reply_markup=None)
        self.bot.send_message(self.admin_manager.get_main_admin_id(), "–í–∞–∫–∞–Ω—Å—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ.")

    def approve_new_unique_vacancy(self, call):
        chat_id = int(call.data.split('_')[-1])
        result = self.users_vacancies.get(chat_id).add_unique_vacancy_to_db()
        self.bot.send_message(chat_id, "–í—ñ—Ç–∞—î–º–æ, –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å—ñ—è –ø—Ä–æ–π—à–ª–∞ –º–æ–¥–µ—Ä—É–≤–∞–Ω–Ω—è —ñ –≤–∂–µ –¥–æ–¥–∞–Ω–∞ –¥–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤–∞–∫–∞–Ω—Å—ñ–π!\n –í–∞–∫–∞–Ω—Å—ñ—è –º–∞—î —Ç–∞–∫–∏–π –≤–∏–≥–ª—è–¥")
        print("result", result)
        if result:
            button = types.InlineKeyboardButton(text="‚ùå –í–∏–¥–∞–ª–∏—Ç–∏", callback_data=f"delete_unique_vacancy_{result}")
            markup = types.InlineKeyboardMarkup().add(button)
            self.bot.send_photo(chat_id, "https://i.ibb.co/ZW5P5PB/hot-vacancy.jpg", reply_markup=markup, caption=format_unique_vacancy(self.users_vacancies.get(chat_id).to_dict()), parse_mode='HTML')
        self.bot.edit_message_reply_markup(chat_id=self.admin_manager.get_main_admin_id(), message_id=call.message.message_id, reply_markup=None)
        self.bot.send_message(self.admin_manager.get_main_admin_id(), "–í–∞–∫–∞–Ω—Å—ñ—é –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ —ñ –¥–æ–¥–∞–Ω–æ –≤ DB.")
        del self.users_vacancies[chat_id]


    def handle_text(self, message):
        self.user_manager.check_and_new_add_user_to_db(message.from_user.id) #threading.Thread(target=check_and_new_add_user_to_db, args=(message.from_user.id, )).start()
        stage = STAGE(self.user_manager.get_stage(message.from_user.id))

        if message.text == "üîç –ü–æ—á–∞—Ç–∏ –ø–æ—à—É–∫!" and stage==STAGE.CREATE_REQUEST:
            if self.users_requests.get(message.from_user.id).language == "":
              self.bot.send_message(message.from_user.id, "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–ª—è –ø–æ—à—É–∫—É (–º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è)!")
              self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:", reply_markup=self.generate_keyboard(categories, 3))
              self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_CATEGORY.value)
            else:
              self.user_manager.set_stage(message.from_user.id, STAGE.START_SEARCH.value)

        if message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é" or message.text == "‚¨ÖÔ∏è":
            self.user_manager.set_stage(message.from_user.id, STAGE.START.value)
            self.show_main_menu(message.from_user.id)
        else:
            stage = STAGE(self.user_manager.get_stage(message.from_user.id))
            print("stage = ", stage)
            handlers = {
                STAGE.START: self.handle_start,
                STAGE.CREATE_REQUEST: self.handle_create_request,
                STAGE.NEXT_PARAM_CATEGORY: self.handle_next_param_category,
                STAGE.NEXT_PARAM_LANGUAGE: self.handle_next_param_language,
                STAGE.NEXT_PARAM_CITY: self.handle_next_param_city,
                STAGE.NEXT_PARAM_POSITION: self.handle_next_param_position,
                STAGE.NEXT_PARAM_EXPERIENCE: self.handle_next_param_experience,
                STAGE.NEXT_PARAM_MIN_SALARY: self.handle_next_param_min_salary,
                STAGE.CREATE_UNIQUE_VACANCY: self.handle_create_unique_vacancy,
                STAGE.CREATE_UV_NEXT_PARAM_CATEGORY: self.handle_create_uv_next_param_category,
                STAGE.CREATE_UV_ADD_JOB_TITLE: self.handle_create_uv_add_job_title,
                STAGE.CREATE_UV_ADD_CATEGORY: self.handle_create_uv_add_category,
                STAGE.CREATE_UV_ADD_COMPANY_NAME: self.handle_create_uv_add_company_name,
                STAGE.CREATE_UV_ADD_DESCRIPTION: self.handle_create_uv_add_description,
                STAGE.CREATE_UV_ADD_SALARY: self.handle_create_uv_add_salary,
                STAGE.CREATE_UV_ADD_EXPERIENCE: self.handle_create_uv_add_experience,
                STAGE.CREATE_UV_ADD_CITY: self.handle_create_uv_add_city,
                STAGE.CREATE_UV_ADD_CONTACT: self.handle_create_uv_add_contact,
                STAGE.CREATE_UV_ADD_POSITION: self.handle_create_uv_add_position,
                STAGE.START_SEARCH: self.start_search,
            }
            handler = handlers.get(stage, self.handle_default)
            handler(message)

    def handle_default(self, message):
        self.bot.send_message(message.from_user.id, "–°–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ —ñ–Ω—à—É –∫–æ–º–∞–Ω–¥—É. –í–≤–µ–¥—ñ—Ç—å /start.") #TODO: –∫—É–¥–∏—Å—å –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏, —Ü—è —á–∞—Å—Ç–∏–Ω–∞ –Ω–µ –ø—Ä–∞—Ü—é—î

    def handle_start(self, message):
        if message.text == "üìã –ú–æ—ó –∑–∞–ø–∏—Ç–∏":
            self.user_manager.set_stage(message.from_user.id, STAGE.MY_REQUESTS.value)
            self.show_user_requests(message.from_user.id)
            self.user_manager.set_stage(message.from_user.id, STAGE.START.value)
        elif message.text == "üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç":
            if self.user_manager.user_can_create_request(message.from_user.id):
              self.show_create_request_menu(message.from_user.id)
              self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_REQUEST.value)
            else:
              self.bot.send_message(message.from_user.id, "–í–∏ –≤–∏—á–µ—Ä–ø–∞–ª–∏ –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –∑–∞ –ø–µ—Ä–µ–¥–ø–ª–∞—Ç–æ—é.")
        elif message.text == "üí≥ –¢–∞—Ä–∏—Ñ–∏ —Ç–∞ –û–ø–ª–∞—Ç–∞":
           subscription_info = get_subscription_info(message.from_user.id)
           self.bot.send_message(message.from_user.id, f"""
                        –í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: {subscription_info}

                        –•–æ—á–µ—Ç–µ –º–∞—Ç–∏ –±—ñ–ª—å—à–µ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π —É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ –Ω–∞—à–æ–≥–æ –±–æ—Ç–∞? –û–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –∑ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–∞—Ä–∏—Ñ—ñ–≤:

                        üî¥ –ï–∫–æ–Ω–æ–º
                        - –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –¥–æ –¥–≤–æ—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å
                        - –¶—ñ–Ω–∞: $1 –Ω–∞ –º—ñ—Å—è—Ü—å
                        - –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /pay1

                        üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç
                        - –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –¥–æ —á–æ—Ç–∏—Ä—å–æ—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å
                        - –¶—ñ–Ω–∞: $2 –Ω–∞ –º—ñ—Å—è—Ü—å
                        - –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /pay2

                        üü¢ –ë—ñ–∑–Ω–µ—Å
                        - –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –¥–æ –¥–µ—Å—è—Ç–∏ –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å
                        - –¶—ñ–Ω–∞: $5 –Ω–∞ –º—ñ—Å—è—Ü—å
                        - –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /pay3

                        –û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –≤–∞—Å —Ç–∞—Ä–∏—Ñ, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –±—ñ–ª—å—à–æ–≥–æ –æ–±—Å—è–≥—É –≤–∞–∫–∞–Ω—Å—ñ–π —Ç–∞ —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π.
                        """)
        elif message.text == "‚ÑπÔ∏è –ü—Ä–æ –±–æ—Ç":
            self.bot.send_message(message.from_user.id, f"")
            # –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–æ—Ç–∞
        elif message.text == "üíº –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –≤–∞–∫–∞–Ω—Å—ñ—é":
            send_job_offer_instructions(self, message.from_user.id)
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UNIQUE_VACANCY.value)
            self.show_create_UV_required_fields_menu(message.from_user.id)
            self.users_vacancies[message.from_user.id] = UniqueVacancy()
        elif message.text == "üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏":
          contact_info = f"""
<b>–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏ —Å–ª—É–∂–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏:</b>
    –ü–Ω-–ü—Ç: <b>–∑ 10:00 –¥–æ 20:00</b>
    –°–±-–ù–¥: <b>–∑ 11:00 –¥–æ 16:00</b>

<b>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</b>
  üìû <a href="tel:+380999999999">+380 (99) 999 99 99</a>
  üìß <a href="mailto:jobhunthelpersupport@gmail.com">jobhunthelpersupport@gmail.com</a>

<i>–©–æ–± –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ:</i>
  """
                # –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
          button =  types.InlineKeyboardButton(text="üì± –ó–≤'—è–∑–∞—Ç–∏—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º", url="https://t.me/anneti_net")
          # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –∑ —Ü—ñ—î—é –∫–Ω–æ–ø–∫–æ—é
          markup =  types.InlineKeyboardMarkup().add(button)
          self.bot.send_message(message.from_user.id, contact_info, reply_markup=markup, parse_mode="HTML")
          # # –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ä–∞–∑–æ–º –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é
          # self.bot.send_message(chat_id, "–©–æ–± –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ:", reply_markup=markup)
        else:
          self.show_main_menu(message.from_user.id)

    def handle_create_request(self, message):
        if message.from_user.id not in self.users_requests:
          self.users_requests[message.from_user.id] = Request()
        print(self.users_requests.get(message.from_user.id))
        if message.text == "üìÇ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:", reply_markup=self.generate_keyboard(categories, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_CATEGORY.value)
        elif message.text == "üèô –ú—ñ—Å—Ç–æ":
            self.bot.send_message(message.from_user.id, "–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=self.generate_keyboard(cities, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_CITY.value)
        elif message.text == "üíº –ü–æ–∑–∏—Ü—ñ—è":
            self.bot.send_message(message.from_user.id, "–í–∏–±–µ—Ä—ñ—Ç—å –≤–∞—à—É –ø–æ–∑–∏—Ü—ñ—é:", reply_markup=self.generate_keyboard(positions, 2))
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_POSITION.value)
        elif message.text == "‚è≥ –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏":
            self.bot.send_message(message.from_user.id, "–í–∫–∞–∂—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É:")
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_EXPERIENCE.value)
        elif message.text == "üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞":
            self.bot.send_message(message.from_user.id, "–í–∫–∞–∂—ñ—Ç—å –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É –∑–∞—Ä–ø–ª–∞—Ç—É (–≥—Ä–Ω):")
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_MIN_SALARY.value)

    def handle_next_param_category(self, message):
        if message.text == "–†–æ–∑—Ä–æ–±–∫–∞":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=self.generate_keyboard(programming_languages, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_LANGUAGE.value)
        elif message.text == "–¢–µ—Ö–Ω—ñ—á–Ω—ñ":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ—á–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=self.generate_keyboard(technical_specialties, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_LANGUAGE.value)
        elif message.text == "–ù–µ—Ç–µ—Ö–Ω—ñ—á–Ω—ñ":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –Ω–µ—Ç–µ—Ö–Ω—ñ—á–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=self.generate_keyboard(nontechnical_specialties, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.NEXT_PARAM_LANGUAGE.value)

    def set_stage_create_request_and_show_menu(self, chat_id):
        self.user_manager.set_stage(chat_id, STAGE.CREATE_REQUEST.value)
        self.show_create_request_menu(chat_id)

    def handle_next_param_language(self, message):
        self.users_requests.get(message.from_user.id).set_language(message.text)
        self.set_stage_create_request_and_show_menu(message.from_user.id)

    def handle_next_param_city(self, message):
        self.users_requests.get(message.from_user.id).set_city(message.text)
        self.set_stage_create_request_and_show_menu(message.from_user.id)

    def handle_next_param_position(self, message):
        self.users_requests.get(message.from_user.id).set_position(message.text)
        self.set_stage_create_request_and_show_menu(message.from_user.id)

    def handle_next_param_experience(self, message):
        self.users_requests.get(message.from_user.id).set_experience(message.text)
        self.set_stage_create_request_and_show_menu(message.from_user.id)

    def handle_next_param_min_salary(self, message):
        self.users_requests.get(message.from_user.id).set_min_salary(message.text)
        self.set_stage_create_request_and_show_menu(message.from_user.id)

    def handle_create_unique_vacancy(self, message):
        if message.text == "‚¨ÖÔ∏è":
            self.user_manager.set_stage(message.from_user.id, STAGE.START.value)
            self.show_main_menu(message.from_user.id)
        elif message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞–∑–∞–¥":
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UNIQUE_VACANCY.value)
            self.show_create_UV_required_fields_menu(message.from_user.id)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –Ω–∞–∑–≤—É –≤–∞–∫–∞–Ω—Å—ñ—ó":
            instructions = """
    üìù <b>–Ø–∫ –Ω–∞–∑–≤–∞—Ç–∏ –≤–∞–∫–∞–Ω—Å—ñ—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ?</b>

    - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∑—Ä–æ–∑—É–º—ñ–ª—ñ —Ç–µ—Ä–º—ñ–Ω–∏ —Ç–∞ —É–Ω–∏–∫–∞–π—Ç–µ –∞–±—Ä–µ–≤—ñ–∞—Ç—É—Ä, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª—ñ.
    - –í–∫–∞–∂—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å –ø–æ–∑–∏—Ü—ñ—ó, —è–∫—â–æ —Ü–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Junior, Middle, Senior).

    <b>–ü—Ä–∏–∫–ª–∞–¥:</b>
    - Junior Python Developer
    - Senior Project Manager
    - Marketing Specialist

    <i>–ù–∞–ø–∏—à—ñ—Ç—å –Ω–∞–∑–≤—É –≤–∞–∫–∞–Ω—Å—ñ—ó:</i>
    """
            self.bot.send_message(message.from_user.id, instructions, parse_mode="HTML")
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_JOB_TITLE.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É", reply_markup=self.generate_keyboard(categories, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_NEXT_PARAM_CATEGORY.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é":
            self.bot.send_message(message.from_user.id, "–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é —ñ–∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É:", reply_markup=self.generate_keyboard(positions, 2))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_POSITION.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –Ω–∞–∑–≤—É –∫–æ–º–ø–∞–Ω—ñ—ó":
            self.bot.send_message(message.from_user.id, "–ù–∞–ø–∏—à—ñ—Ç—å –Ω–∞–∑–≤—É –∫–æ–º–ø–∞–Ω—ñ—ó –∞–±–æ –ü–Ü–ë —Ä–æ–±–æ—Ç–æ–¥–∞–≤—Ü—è")
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_COMPANY_NAME.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –æ–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó":
            instructions = """
    üìÑ <b>–Ø–∫ –Ω–∞–ø–∏—Å–∞—Ç–∏ –æ–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó –ø—Ä–∞–≤–∏–ª—å–Ω–æ?</b>

    –û–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó –¥–æ–ø–æ–º–∞–≥–∞—î –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —â–æ —Å–∞–º–µ –æ—á—ñ–∫—É—î—Ç—å—Å—è –≤—ñ–¥ –Ω–∏—Ö –Ω–∞ —Ü—ñ–π –ø–æ—Å–∞–¥—ñ, –∞ —Ç–∞–∫–æ–∂ —è–∫—ñ –Ω–∞–≤–∏—á–∫–∏ —Ç–∞ –¥–æ—Å–≤—ñ–¥ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–ª—è —É—Å–ø—ñ—à–Ω–æ—ó —Ä–æ–±–æ—Ç–∏.

    <b>–û—Å–Ω–æ–≤–Ω—ñ –ø–æ—Ä–∞–¥–∏:</b>
    - –í–∫–∞–∂—ñ—Ç—å –∫–ª—é—á–æ–≤—ñ –æ–±–æ–≤'—è–∑–∫–∏ —Ç–∞ –∑–∞–¥–∞—á—ñ, —è–∫—ñ –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫.
    - –û–ø–∏—Å—É–π—Ç–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –Ω–∞–≤–∏—á–∫–∏ —Ç–∞ –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—é.
    - –ó–∞–∑–Ω–∞—á—Ç–µ —É–º–æ–≤–∏ –ø—Ä–∞—Ü—ñ, –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –¥–ª—è —Ä–æ–∑–≤–∏—Ç–∫—É —Ç–∞ –∫–∞—Ä'—î—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç—É.
    - –£–Ω–∏–∫–∞–π—Ç–µ –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Ñ—Ä–∞–∑, –Ω–∞–¥–∞–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–µ—Ç–∞–ª—ñ.

    <b>–ü—Ä–∏–∫–ª–∞–¥:</b>
    <i>
    –û–±–æ–≤'—è–∑–∫–∏:
    - –†–æ–∑—Ä–æ–±–∫–∞ —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤ –Ω–∞ Python.
    - –°–ø—ñ–≤–ø—Ä–∞—Ü—è –∑ –∫–æ–º–∞–Ω–¥–æ—é —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –Ω–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π.
    - –ù–∞–ø–∏—Å–∞–Ω–Ω—è —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó.

    –í–∏–º–æ–≥–∏:
    - –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏ –∑ Python –≤—ñ–¥ 2 —Ä–æ–∫—ñ–≤.
    - –ó–Ω–∞–Ω–Ω—è —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—ñ–≤ Django –∞–±–æ Flask.
    - –í–º—ñ–Ω–Ω—è –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∞–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é –≤–µ—Ä—Å—ñ–π (Git).

    –ú–∏ –ø—Ä–æ–ø–æ–Ω—É—î–º–æ:
    - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—É –∑–∞—Ä–æ–±—ñ—Ç–Ω—É –ø–ª–∞—Ç—É.
    - –ì–Ω—É—á–∫–∏–π –≥—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏ —Ç–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ.
    - –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ–≥–æ —Ä–æ–∑–≤–∏—Ç–∫—É —Ç–∞ –∫–∞—Ä'—î—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç—É.
    </i>

    ‚úèÔ∏è <i>–ù–∞–ø–∏—à—ñ—Ç—å –æ–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó:</i>
    """
            self.bot.send_message(message.from_user.id, instructions, parse_mode="HTML")
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_DESCRIPTION.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –∑–∞—Ä–æ–±—ñ—Ç–Ω—é –ø–ª–∞—Ç—É":
            instructions = """
    üíµ <b>–Ø–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –∑–∞—Ä–æ–±—ñ—Ç–Ω—É –ø–ª–∞—Ç—É?</b>

    –í–∫–∞–∑—É–≤–∞–Ω–Ω—è –∑–∞—Ä–æ–±—ñ—Ç–Ω–æ—ó –ø–ª–∞—Ç–∏ —î –≤–∞–∂–ª–∏–≤–∏–º –µ–ª–µ–º–µ–Ω—Ç–æ–º –≤–∞–∫–∞–Ω—Å—ñ—ó, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –º–æ–∂–µ –∑–Ω–∞—á–Ω–æ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–∞ —è–∫—ñ—Å—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤, —è–∫—ñ –≤—ñ–¥–≥—É–∫–Ω—É—Ç—å—Å—è –Ω–∞ –≤–∞—à—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é.

    <b>–û—Å–Ω–æ–≤–Ω—ñ –ø–æ—Ä–∞–¥–∏:</b>
    - –í–∫–∞–∑—É–π—Ç–µ –∑–∞—Ä–æ–±—ñ—Ç–Ω—É –ø–ª–∞—Ç—É –≤ –º—ñ—Å—è—á–Ω–æ–º—É –∞–±–æ —Ä—ñ—á–Ω–æ–º—É –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç—ñ.
    - –ó–∞–∑–Ω–∞—á–∞–π—Ç–µ –≤–∞–ª—é—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, UAH, USD, EUR).
    - –ú–æ–∂–Ω–∞ –≤–∫–∞–∑—É–≤–∞—Ç–∏ –¥—ñ–∞–ø–∞–∑–æ–Ω, —è–∫—â–æ —Ç–æ—á–Ω–∞ —Å—É–º–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.

    <b>–ü—Ä–∏–∫–ª–∞–¥–∏:</b>
    - 20,000 - 30,000 UAH
    - –í—ñ–¥ 50,000 USD –Ω–∞ —Ä—ñ–∫
    - 25,000 UAH

    üìù <i>–ù–∞–ø–∏—à—ñ—Ç—å –∑–∞—Ä–æ–±—ñ—Ç–Ω—É –ø–ª–∞—Ç—É, —è–∫—É –≤–∏ –ø—Ä–æ–ø–æ–Ω—É—î—Ç–µ:</i>
    """
            self.bot.send_message(message.from_user.id, instructions, parse_mode="HTML")
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_SALARY.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –º—ñ—Å—Ç–æ —Ä–æ–±–æ—Ç–∏":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ —Ä–æ–±–æ—Ç–∏ –∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ:", reply_markup=self.generate_keyboard(cities, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_CITY.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –∑–≤'—è–∑–∫—É":
            self.bot.send_message(message.from_user.id, " –ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –∑–≤'—è–∑–∫—É, —è–∫–∏–π –¥–æ–ø–æ–º–æ–∂–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ –≤–∞–º–∏ —â–æ–¥–æ –≤–∞–∫–∞–Ω—Å—ñ—ó. –í–∏ –º–æ–∂–µ—Ç–µ –≤–∫–∞–∑–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π –∑—Ä—É—á–Ω–∏–π —Å–ø–æ—Å—ñ–± –∑–≤'—è–∑–∫—É, —Ç–∞–∫–∏–π —è–∫ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –∞–±–æ –ª–æ–≥—ñ–Ω –≤ Telegram.")
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_CONTACT.value)
        elif message.text == "–î–æ–¥–∞—Ç–∏ –¥–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏":
            self.bot.send_message(message.from_user.id, "–ù–∞–ø–∏—à—ñ—Ç—å –Ω–µ–æ–±—ñ—Ö–¥–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É —Ä–æ–±–æ—Ç–∏")
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_EXPERIENCE.value)
        elif message.text == "–û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é —ñ–∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é:", reply_markup=self.generate_keyboard(positions, 2))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_POSITION.value)
        elif message.text == "‚û°Ô∏è":
            if self.check_all_required_fields_filled(message.from_user.id):
                self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UNIQUE_VACANCY.value)
                self.show_create_UV_optional_fields_menu(message.from_user.id)
        elif message.text == "‚úÖ–ì–æ—Ç–æ–≤–æ":
            print(self.users_vacancies.get(message.from_user.id))
            self.send_new_vacancy_to_admin(message.from_user.id)
            self.bot.send_message(message.from_user.id, "–í–∞—à–∞ –≤–∞–∫–∞–Ω—Å—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –í–æ–Ω–∞ –±—É–¥–µ –¥—ñ–π—Å–Ω–∞ 14 –¥–Ω—ñ–≤ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏")
            self.user_manager.set_stage(message.from_user.id, STAGE.START.value)
            self.show_main_menu(message.from_user.id)

    def check_all_required_fields_filled(self, chat_id):
        is_all_required_fields_filled = True
        str_to_user = "–ú–∏ –Ω–µ –º–æ–∂–µ–º–æ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤–∞—à—É –≤–∞–∫–∞–Ω—Å—ñ—é –Ω–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä—É, –∞–¥–∂–µ –≤–∏ –Ω–µ –∑–∞–ø–æ–≤–Ω–∏–ª–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: \n"
        if self.users_vacancies.get(chat_id).title == "":
          is_all_required_fields_filled = False
          str_to_user += "- –ù–∞–∑–≤–∞\n"
        if self.users_vacancies.get(chat_id).category == "":
          is_all_required_fields_filled = False
          str_to_user += "- –ö–∞—Ç–µ–≥–æ—Ä—ñ—è\n"
        if self.users_vacancies.get(chat_id).contact == "":
          str_to_user += "- –ö–æ–Ω—Ç–∞–∫—Ç\n"
          is_all_required_fields_filled = False
        if not is_all_required_fields_filled:
          self.bot.send_message(chat_id, str_to_user)
        return is_all_required_fields_filled

    def handle_create_uv_next_param_category(self, message):
        if message.text == "–†–æ–∑—Ä–æ–±–∫–∞":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è:", reply_markup=self.generate_keyboard(programming_languages, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_CATEGORY.value)
        elif message.text == "–¢–µ—Ö–Ω—ñ—á–Ω—ñ":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ—á–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å:", reply_markup=self.generate_keyboard(technical_specialties, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_CATEGORY.value)
        elif message.text == "–ù–µ—Ç–µ—Ö–Ω—ñ—á–Ω—ñ":
            self.bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –Ω–µ—Ç–µ—Ö–Ω—ñ—á–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å:", reply_markup=self.generate_keyboard(nontechnical_specialties, 3))
            self.user_manager.set_stage(message.from_user.id, STAGE.CREATE_UV_ADD_CATEGORY.value)

    def set_stage_create_unique_vacancy_and_show_menu(self, chat_id, is_optional):
        self.user_manager.set_stage(chat_id, STAGE.CREATE_UNIQUE_VACANCY.value)
        if not is_optional:
            self.show_create_UV_required_fields_menu(chat_id)
        else:
            self.show_create_UV_optional_fields_menu(chat_id)

    def handle_create_uv_add_job_title(self, message):
        self.users_vacancies.get(message.from_user.id).set_title(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = False)

    def handle_create_uv_add_category(self, message):
        self.users_vacancies.get(message.from_user.id).set_category(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = False)

    def handle_create_uv_add_company_name(self, message):
        self.users_vacancies.get(message.from_user.id).set_company(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = True)

    def handle_create_uv_add_description(self, message):
        self.users_vacancies.get(message.from_user.id).set_description(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = True)

    def handle_create_uv_add_salary(self, message):
        self.users_vacancies.get(message.from_user.id).set_salary(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = True)

    def handle_create_uv_add_experience(self, message):
        self.users_vacancies.get(message.from_user.id).set_experience(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = True)

    def handle_create_uv_add_city(self, message):
        self.users_vacancies.get(message.from_user.id).set_city(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = True)

    def handle_create_uv_add_contact(self, message):
        self.users_vacancies.get(message.from_user.id).set_contact(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = False)

    def handle_create_uv_add_position(self, message):
        self.users_vacancies.get(message.from_user.id).set_position(message.text)
        self.set_stage_create_unique_vacancy_and_show_menu(message.from_user.id, is_optional = True)

    def start_search(self, message):
        self.show_main_menu(message.from_user.id)
        print("start_seach_and_send_unique_vacancy")
        if self.users_requests.get(message.from_user.id).add_request_to_db(message.from_user.id, self.db_manager):
          #stop_scheduler()
          start_seach_and_send_unique_vacancy(self.users_requests.get(message.from_user.id), message.from_user.id)
          threads = []
          threads.append(threading.Thread(target=start_seach_and_send_workua_vacancy, args=(self.users_requests.get(message.from_user.id), message.from_user.id)))
          threads.append(threading.Thread(target=start_seach_and_send_dou_vacancy, args=(self.users_requests.get(message.from_user.id), message.from_user.id)))
          threads.append(threading.Thread(target=start_seach_and_send_djinni_vacancy, args=(self.users_requests.get(message.from_user.id), message.from_user.id)))
          threads.append(threading.Thread(target=start_seach_and_send_robota_vacancy, args=(self.users_requests.get(message.from_user.id), message.from_user.id)))
          threads.append(threading.Thread(target=start_seach_and_send_jooble_vacancy, args=(self.users_requests.get(message.from_user.id), message.from_user.id)))

          for thread in threads:
              thread.start()

          for thread in threads:
              thread.join()
           #start_scheduler()
          self.user_manager.set_stage(message.from_user.id, STAGE.START.value)
          del self.users_requests[message.from_user.id]
        else:
          self.bot.send_message(message.from_user.id, "–¢–∞–∫–∏–π –∑–∞–ø–∏—Ç –≤–∂–µ —ñ—Å–Ω—É—î.")
          self.user_manager.set_stage(message.from_user.id, STAGE.START.value)
          del self.users_requests[message.from_user.id]

TOKEN = '7161535193:AAG2EDGz-thMU4zFHRS0ZC3OoqnmGr9L79E'
PAYMENTS_PROVIDER_TOKEN = '1661751239:TEST:mU24-EUf1-h8WQ-vwr0'

bot = telebot.TeleBot(TOKEN)
request = Request()

def get_end_subscription_date():
    current_date = datetime.now().date()
    return current_date + relativedelta(months=1)

cities = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "remote", "Kyiv", "Vinnytsia", "Dnipro", "Ivano-Frankivsk", "Zhytomyr", "Zaporizhzhia", "Lviv", "Mykolaiv", "Odesa", "Ternopil", "Kharkiv", "Khmelnytskyi", "Cherkasy", "Chernihiv", "Chernivtsi", "Uzhhorod"]
positions = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "Trainee","Intern" , "Junior", "Middle", "Senior", "Team Lead", "Chief of", "Head of"]

categories = ["–†–æ–∑—Ä–æ–±–∫–∞", "–¢–µ—Ö–Ω—ñ—á–Ω—ñ", "–ù–µ—Ç–µ—Ö–Ω—ñ—á–Ω—ñ"]

programming_languages = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "JavaScript", "Front-End", "Fullstack", "Java", "C#", ".NET", "Python", "PHP", "Node.js", "iOS", "Android", "React Native", "C", "C++", "Embedded", "Flutter", "Golang", "Ruby", "Scala", "Salesforce", "Rust", "Elixir", "Kotlin", "ERP Systems"]
technical_specialties = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "QA Manual", "QA Automation", "Design", "2D/3D Artist", "Illustrator", "Gamedev", "Project Manager", "Product Manager", "Product Owner", "Delivery Manager", "Scrum Master", "Agile Coach", "Architect", "CTO", "DevOps", "Security", "Sysadmin", "Business Analyst", "Data Science", "Data Analyst", "Data Engineer", "SQL", "DBA", "Technical Writing"]
nontechnical_specialties = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "Marketing", "Sales", "Lead Generation", "SEO", "HR Recruiter", "Customer Support", "Technical Support", "Head", "Chief", "Finances"]

db_config = {
    "host": "0.tcp.eu.ngrok.io",
    "port": 13051,
    "user": "root",
    "password": "root",
    "database": "scraping_service"
}

db_manager = DatabaseManager(db_config)
user_manager = UserManager(db_manager)
admin_manager = AdminManager(db_manager)

# scheduler = JobScheduler(db_manager)
# scheduler.start_scheduler()
# threading.Thread(target=scheduler.run_scheduler).start()

bot_manager = BotManager(TOKEN, PAYMENTS_PROVIDER_TOKEN, db_manager, user_manager, admin_manager)
bot_manager.run()

scheduler.stop_scheduler()

# –ó–ê–î–ê–ß–Ü:
# DONE 2. –ó—Ä–æ–±–∏—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–≤–æ—ó—Ö –≤–∞–∫–∞–Ω—Å—ñ–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥ –≤–∞–∫–∞–Ω—Å—ñ—î—é #done
# DONE 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∫–≤–µ—Å—Ç—ñ–≤, —â–æ–± –±—ñ–ª—å—à–µ –Ω—ñ–∂ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–µ –º–æ–∂–Ω–∞ –±—É–ª–æ –∑—Ä–æ–±–∏—Ç–∏
# 4. –í —Ü—ñ–ª–æ–º—É –∑—Ä–æ–±–∏—Ç–∏ –±—ñ–ª—å—à –≥–∞—Ä–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
# DONE 5. –ó—Ä–æ–±–∏—Ç–∏ —à–æ–± –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ñ–æ–Ω–æ–≤–∏–π –ø–æ—à—É–∫ –≤–∞–∫–∞–Ω—Å—ñ–π –∑–∞–ø—É—Å–∫–∞–≤—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∞ –Ω–µ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –º–∏ –≤—Ä—É—á–Ω—É –¥–æ–¥–∞–ª–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Ç
# DONE 6. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —è–∫ —ñ–Ω—à—ñ —Å–∞–π—Ç–∏ –ø—Ä–∞—Ü—é—é—Ç—å –∑ "–°++", "–°#", —è–∫—â–æ —î –ø—Ä–æ–±–ª–µ–º–∏ - —à–≤–∏–¥–∫–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–æ workua
# DONE 7. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ PyCharm —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —è–∫ —à–≤–∏–¥–∫–æ –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –∑–∞–ø–∏—Ç–∞–º–∏ –¥–æ –ë–î
# DONE 8. –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è robota
# –î–ª—è djini –∫–∞–∫–∞—è-—Ç–æ –∑–∞—â–∏—Ç–∞ —Å—Ç–æ–∏—Ç, –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ, –ø–æ—Ö–æ–¥—É –Ω–µ–ª—å–∑—è —Å–∫—Ä–∞–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞–∫–∞–Ω—Å–∏–∏
# 9. –ó—Ä–æ–±–∏—Ç–∏, —â–æ–± –≤–∏–≤–æ–¥–∏–ª–æ—Å—å –ø–æ 10 –∑–∞–ø–∏—Ç—ñ–≤, –∞ —ñ–Ω—à—ñ —â–æ–± –ø—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –©–ï
# DONE 10. –ó—Ä–æ–±–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–Ω–∞–ª –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤–∞–∫–∞–Ω—Å—ñ–π, —è–∫—ñ —î –ª–∏—à–µ –≤ –±–æ—Ç—ñ
# DONE 10. –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª —â–æ–± –Ω–µ —Ç—ñ–ª—å–∫–∏ —Å–∫—Ä–∞–ø–∏—Ç–∏, –∞ –π –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –≤–∞–∫–∞–Ω—Å—ñ—ó
# 11. –ü–æ–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π
# REJECTED 11. –î–æ–¥–∞—Ç–∏ –∞–¥–º—ñ–Ω–∞, –º–∞–±—É—Ç—å –∑—Ä–æ–±–∏—Ç–∏ –¥–ª—è –Ω—å–æ–≥–æ —Ç—Ä–æ—Ö–∏ —ñ–Ω—à–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
# 12. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤—Å—ñ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∞—Ü—é—é—Ç—å —ñ —Ä—ñ–∑–Ω–∏—Ö –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è—Ö, –±–æ –∑–¥–∞—î—Ç—å—Å—è —â–æ –Ω—ñ, —Ä—ñ—à–µ–Ω–Ω—è –ø–æ–≤'—è–∑–∞–Ω–µ –∑ —Å—Ç–∞–≤–Ω–æ–≤–ª–µ–Ω–Ω—è–º stage - –º–æ–∂–ª–∏–≤–æ –≤–∏—Ä—ñ—à–µ–Ω–æ?
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –Ω–µ—Ç —Ç–∞–∫ —Å –∑–∞–ø—Ä–æ—Å–æ–º C#, —Å–∫—Ä–∏–Ω –µ—Å—Ç—å ?
# DONE 13. –°–¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π stage, —Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö! –ê–õ–ï –¥–æ–≤–≥–æ –ø—Ä–∞—Ü—é—î –≤ colab
# DONE 14. –í –±–∞–∑–µ –¥–∞–Ω–Ω–∏—Ö —Å–¥–µ–ª–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ img_src
# DONE 15. –ü–æ—Ñ–∏–∫—Å–∏—Ç—å –Ω–µ–Ω—É–∂–Ω–æ–µ –º–æ—Ä–≥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
# 16. –°–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã —é–∑–µ—Ä –º–æ–≥ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞–∫–∞–Ω—Å–∏–π –¥–æ–±–∞–≤–ª—è—Ç—å, –∏ —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã —ç—Ç–æ –±—ã–ª–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ
# 17. –ï—Å–ª–∏ —Å–º–æ–∂–µ–º —á—Ç–æ–±—ã –∞–¥–º–∏–Ω –º–æ–≥ –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω–∏—é –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–≥
# DONE 18. –ù–µ —É–≤–µ—Ä–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ –∫–∞–∫–æ–π-—Ç–æ –±–∞–≥ –≤ —Å–∫—Ä–∞–ø–∏–Ω–≥–µ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–∞ —Ñ–æ–Ω–µ, –ø–æ—á–µ–º—É-—Ç–æ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø—Ä–∏—Å—ã–ª–∞—é—Ç—Å—è. –ú–æ–∂–Ω–æ –≥–ª—è–Ω—É—Ç—å –¥–µ—Ç–∞–ª—å–Ω–µ–µ - –ü–û–ß–¢–ò –Ω–∞ 100% —É–≤–µ—Ä–µ–Ω —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –¥–ª–∏–Ω–Ω–æ–π —Ç–æ-–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞, —Ç–æ-–ª–∏ —á–µ–≥–æ-—Ç–æ —Ç–∞–∫–æ–≥–æ
# DONE 19. –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –ø–æ–∏—Å–∫–µ –Ω–∞ —Ñ–æ–Ω–µ —Ç–æ–∂–µ
# 20. –ü–æ–¥—É–º–∞—Ç—å, –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã –ø–æ –æ–¥–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –±–¥ –¥–æ–±–∞–≤–ª—è–ª–æ—Å—å –∏ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å?
# 21. –°–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã –ª–æ–≥–∏ –≤—ã–≤–æ–¥–∏–ª–∏—Å—å

# IN PROGRESS. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥—É, —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª–∞—Å–∏, —â–æ–± –≤—Å–µ –≥–∞—Ä–Ω–æ –≤–∏–≥–ª—è–¥–∞–ª–æ - –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞ –±—É–¥—å —è–∫–æ–º—É –µ—Ç–∞–ø—ñ, –±–∞–∂–∞–Ω–æ —è–∫–æ–º–æ–≥–∞ —Ä–∞–Ω—ñ—à–µ
# DONE!. –ú–æ–∂–ª–∏–≤–æ —â–µ –ø–æ–¥—É–º–∞—Ç–∏ –∑ –ø—Ä–∏–≤–æ–¥—É –æ–ø–ª–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ—ñ–≤ –≥—Ä–æ—à–∏–º–∞
# . –ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ —Å–∏—Å—Ç–µ–º—É (optional), –∞–ª–µ –±–∞–∂–∞–Ω–æ