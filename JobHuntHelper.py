# -*- coding: utf-8 -*-
"""JobHuntHelper.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fRXwhZPQ85BIyXtEQJKq5KGeK7UnnLet
"""

!pip install telebot > null
!pip install selenium > null
!apt-get update > null
!apt-get install -y chromium-chromedriver > null
!pip install mysql-connector-python > null

import telebot
from telebot import types
from enum import Enum
from urllib.parse import urlencode
from selenium import webdriver
import mysql.connector
from threading import Lock

# –°–æ–∑–¥–∞—Ç—å –ø—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
connection_pool = mysql.connector.pooling.MySQLConnectionPool(
    pool_name="my_pool",
    pool_size=5,  # –ó–∞–¥–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    host="4.tcp.eu.ngrok.io",
    port=16590,
    user="root",
    password="root",
    database="scraping_service"
)

import mysql.connector

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø—É–ª–∞
def get_connection():
    return connection_pool.get_connection()

# –ú—å—é—Ç–µ–∫—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
query_lock = Lock()

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
def execute_query(query, params=None):
  with query_lock:
    connection = get_connection()
    cursor = connection.cursor()
    try:
        if params:
            cursor.execute(query, params)
        else:
            cursor.execute(query)

        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (SELECT), –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if query.strip().upper().startswith('SELECT'):
            results = cursor.fetchall()
        else:
            # –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã–µ (INSERT, UPDATE, DELETE),
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
            connection.commit()
            results = []

    except Exception as e:
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥–∏–º –µ–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        results = None

    cursor.close()
    connection.close()
    return results

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
result = execute_query("SELECT * FROM users")
if result:
    for row in result:
        print(row)
else:
    print("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.")


#print("AAAA: ", execute_query(f"INSERT INTO users (chat_id, paid_subscription) VALUES ({10}, 0);"))

from urllib.parse import urlencode, quote

class EXPERIENCE(Enum):
  DEFAULT_VALUE = -2
  STUDENT = -1
  WITHOUT_EXPERIENCE = 0
  ONE_YEAR = 1
  TWO_YEAR = 2
  THREE_YEAR = 3
  FOUR_YEAR = 4
  FIVE_YEAR = 5

def build_url(base_url, **params):
  # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏, —è–∫—ñ –º–∞—é—Ç—å None –∞–±–æ –ø–æ—Ä–æ–∂–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
  filtered_params = {k: v for k, v in params.items() if v}
  query_string = urlencode(filtered_params)
  return f"{base_url}?{query_string}" if query_string else base_url

def build_url_djinni(**params):
  base_url = "https://djinni.co/jobs/"

  params["location"] = params["location"].lower()
  if params["location"] == "remote":
    params["employment"]="remote"
    del params["location"]

  if params["exp_level"] == EXPERIENCE.DEFAULT_VALUE.value or params["exp_level"] > EXPERIENCE.FIVE_YEAR.value:
     params["exp_level"] = ""
  else:
     params["exp_level"] = str(params["exp_level"]) + 'y'
  if params["exp_level"] == "0y":
     params["exp_level"] = "no_exp"

  params["exp_rank"] = params["exp_rank"].lower()
  return build_url(base_url, **params)

def build_url_workua(language='', city='', position='', min_salary=0, experience=EXPERIENCE.DEFAULT_VALUE.value, **params):
  base_url = "https://www.work.ua/jobs"
  if city:
    base_url += '-' + city
  if language:
    base_url += '-' + quote(language)
  if position:
    base_url += '+' + position
  base_url += '/'
  salaryidfrom=''
  if min_salary:
    if 3000 <= min_salary and min_salary < 5000:
      params["salaryfrom"] = 2
    elif 5000 <= min_salary and min_salary < 7000:
      params["salaryfrom"] = 3
    elif 7000 <= min_salary and min_salary < 10000:
      params["salaryfrom"] = 4
    elif 10000 <= min_salary and min_salary < 15000:
      params["salaryfrom"] = 5
    elif 15000 <= min_salary and min_salary < 20000:
      params["salaryfrom"] = 6
    elif 20000 <= min_salary and min_salary < 30000:
      params["salaryfrom"] = 7
    elif min_salary > 30000:
      params["salaryfrom"] = 8

  if experience == EXPERIENCE.WITHOUT_EXPERIENCE.value:
    params["experience"] = 1
  elif experience == EXPERIENCE.STUDENT.value:
    params["student"] = 1

  return build_url(base_url, **params)


def convert_uah_to_usd_for_djinni(uah_amount, exchange_rate):
  # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω—å –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è
  round_values = [1500, 2500, 3500, 4500, 5500, 6500, 7500, 8500]
  usd_amount = uah_amount / exchange_rate
  if (usd_amount < 1500):
    return ''
  rounded_down_value = max([value for value in round_values if value <= usd_amount], default=min(round_values))
  return rounded_down_value

def build_url_dou(**params):
  base_url = "https://jobs.dou.ua/vacancies/"
  if params["city"] == "remote":
      del params["city"]
      params["remote"] = 'remote'

  if params.get("position"):
      params["search"] += " " + params["position"]
      del params["position"]
  if params["exp"] == EXPERIENCE.STUDENT.value or params["exp"] == EXPERIENCE.WITHOUT_EXPERIENCE.value or params["exp"] == EXPERIENCE.ONE_YEAR.value:
     params["exp"] = "0-1"
  elif params["exp"] == EXPERIENCE.TWO_YEAR.value or params["exp"] == EXPERIENCE.THREE_YEAR.value:
     params["exp"] = "1-3"
  elif params["exp"] == EXPERIENCE.FOUR_YEAR.value or params["exp"] == EXPERIENCE.FIVE_YEAR.value:
     params["exp"] = "3-5"
  elif params["exp"] > EXPERIENCE.FIVE_YEAR.value:
     params["exp"] = "5plus"
  else:
    del params["exp"]

  return build_url(base_url, **params)

def build_url_robota(language='', city='', **params):
  base_url = "https://robota.ua/zapros/"
  if language:
      base_url += quote(language).lower()
  if params["position"]:
      base_url += '-' + params["position"].lower()
      del params["position"]
  base_url += '/'
  if city == "remote":
      params["scheduleIds"] = 3
  elif city:
      base_url += city.lower() + '/'

  if params["experience"] == EXPERIENCE.WITHOUT_EXPERIENCE.value:
     params["experienceType"] = "true"
  params["experience"] = ""

  return build_url(base_url, **params)


def build_url_jooble(**params):
  base_url = "https://ua.jooble.org/SearchResult"

  if params["workExp"] == EXPERIENCE.STUDENT.value or params["workExp"] == EXPERIENCE.WITHOUT_EXPERIENCE.value:
    params["workExp"] = 1
  else:
    params["workExp"] = ""

  if params["rgns"] == "remote":
    params["loc"]=2
    params["rgns"] = ""
  return build_url(base_url, **params)


url = build_url_robota(
    language="c++",
    city="kyiv",
    position="junior",
    salary=20340,
    experience=0
)
print(url)

url = build_url_workua(
    language="c++",
    city="kyiv",
    #position="junior",
    #min_salary=20340,
    #experience=0,
    days=122
)
print(url)


url = build_url_djinni(
    all_keywords="python",
    primary_keyword="c#",
    region="UKR",
    location="Kyiv",
    exp_level=-2,
    exp_rank="junior",
    salary=convert_uah_to_usd_for_djinni(20, 39.1),
    keywords="c++"
)
print(url)

url = build_url_dou(city="remote", search="c++", position="junior", exp=1) #–≤ –¥–æ—É –º–æ–∂–Ω–∞ —Å–∫—Ä–∞–ø–∏—Ç—å —ñ –ø–æ 0-1 —ñ –ø–æ 1-3
print(url)

jooble_url = build_url_jooble(date=3, #—â–æ–± –≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é –Ω–µ–¥—ñ–ª–ª—é
                              rgns="remote",
                              salaryMin="1000",
                              ukw="junior" + ' ' + "c++",
                              workExp=0
                              )
print(jooble_url)

import requests
import codecs
from bs4 import BeautifulSoup as BS
from random import randint
from urllib.parse import urlencode
import re


__all__ = ('work', "robota", 'dou', 'djinni')

headers = [
    {'User-Agent': 'Mozilla/5.0 (Windows NT 5.1; rv:47.0) Gecko/20100101 Firefox/47.0',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'},
    {'User-Agent': 'Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'},
    {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; rv:53.0) Gecko/20100101 Firefox/53.0',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'}
    ]



def work(url, city=None, language=None):
    jobs = []
    errors = []
    domain = 'https://www.work.ua'
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_div = soup.find('div', id='pjax-job-list')
            if main_div:
                div_lst = main_div.find_all('div', attrs={'class': 'job-link'})
                # —ñ–≥–Ω–æ—Ä—É—î–º–æ –≤–∞–∫–∞–Ω—Å—ñ—ó –ø—ñ—Å–ª—è p –∑ —Ç–µ–∫—Å—Ç–æ–º –í–∞–∫–∞–Ω—Å—ñ—ó, –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ —ñ–∑ –∑–∞–ø–∏—Ç–æ–º ¬´python junior¬ª —É –ö–∏—î–≤—ñ
                # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–ø–∏—Å–∫—É –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥—ñ–≤—ñ–≤, —è–∫—ñ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –ø–µ—Ä–µ–¥ –≤–∫–∞–∑–∞–Ω–∏–º —Ç–µ–≥–æ–º <p>
                target_p = soup.find('p', class_='text-default-7 add-bottom')

                result_divs = []
                if target_p:
                  for div in target_p.find_all_previous('div', class_='job-link'):
                      result_divs.append(div)
                else:
                  result_divs = div_lst


                for div in result_divs:
                    title = div.find('h2')
                    href = title.a['href']
                    content = div.p.text
                    description = re.sub(r'\s+', ' ', content).strip()
                    img_div = div.find('div', class_ = 'add-bottom')

                    spans = div.find_all('span',  class_='strong-600')
                    salary = '0'
                    company = ''
                    if len(spans)==2:
                      salary = spans[0].text
                      company = spans[1].text
                    else:
                      company = spans[0].text

                    if img_div:
                      img_tag = img_div.find('img')
                      if img_tag:  # –Ø–∫—â–æ —Ç–µ–≥ <img> –ø—Ä–∏—Å—É—Ç–Ω—ñ–π
                          img_src = img_tag['src']
                      else:
                          img_src = 'https://st.work.ua/i/work-ua-knowledge-graph.jpg'

                    jobs.append({'title': title.text, 'img_source': img_src, 'url': domain + href,
                                 'description': description, 'company': company,
                                 'city_id': city, 'language_id': language,'salary': salary, 'site': "workua"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def dou_image(url):
    image_src = ''
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            comp_div = soup.find('div', attrs={'class': 'b-compinfo'})
            if comp_div:
                a = comp_div.find('a', attrs={'class': 'logo'})
                image_src = a.img['src']

    return image_src


def dou(url, city=None, language=None):
    jobs = []
    errors = []

    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_div = soup.find('div', id='vacancyListId')
            if main_div:
                li_lst = main_div.find_all('li', attrs={'class': 'l-vacancy'})
                for li in li_lst:
                    title = li.find('div', attrs={'class': 'title'})
                    href = title.a['href']
                    cont = li.find('div', attrs={'class': 'sh-info'})
                    content = cont.text
                    company = 'No name'
                    salary = '0'
                    a = title.find('a', attrs={'class': 'company'})
                    img_src = dou_image(href)
                    if a:
                        company = a.text
                    jobs.append({'title': title.text, 'img_source': img_src, 'url': href,
                                 'description': content, 'company': company,
                                 'city_id': city, 'language_id': language, 'salary': salary, 'site': "dou"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def djinni(url, city=None, language=None):
    jobs = []
    errors = []
    domain = 'https://djinni.co'
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_ul = soup.find('ul',  attrs={'class': 'list-unstyled list-jobs mb-4'})
            if main_ul:
                li_lst = main_ul.find_all('li',
                                          attrs={'class': 'list-jobs__item'})
                for li in li_lst:
                    title_div = li.find('div',
                                    attrs={'class': 'job-list-item__title'})
                    if title_div:
                        title = title_div.a
                        href = title['href']

                    else:
                        print("Div –∑ –∫–ª–∞—Å–æ–º 'job-list-item__title' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")

                    cont = li.find('div', attrs={'class': 'job-list-item__description'})
                    span = cont.find('span')
                    content = span.text
                    company = 'No name'
                    span_salary = li.find('span', attrs={'class': 'public-salary-item'})
                    if span_salary:
                        salary = span_salary.text
                    else:
                        salary='0'
                    comp = li.find('a', attrs={'class': 'mr-2'})

                    img_div = li.find('div', attrs={'class': 'userpic-wrapper userpic-color_2 userpic_xs userpic-transparent userpic--logo'})
                    if img_div:
                        img_src = img_div.img['src']
                    else:
                        img_src = 'https://sourcingsummit.net/sosutech/wp-content/uploads/sites/30/2017/07/djinnix505x235-1.jpg'

                    if comp:
                        company = comp.text

                    jobs.append({'title': title.text, 'img_source': img_src, 'url': domain+href,
                                 'description': content, 'company': company,
                                 'city_id': city, 'language_id': language, 'salary': salary, 'site': "djinni"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def helper_robota(url):
    jobs = []
    errors = []
    domain = 'https://djinni.co'
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_ul = soup.find('ul',  attrs={'class': 'list-unstyled list-jobs mb-4'})
            if main_ul:
                li_lst = main_ul.find_all('li',
                                          attrs={'class': 'list-jobs__item'})
                for li in li_lst:
                    title_div = li.find('div',
                                    attrs={'class': 'job-list-item__title'})
                    if title_div:
                        title = title_div.a
                        href = title['href']

                    else:
                        print("Div –∑ –∫–ª–∞—Å–æ–º 'job-list-item__title' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")

                    cont = li.find('div', attrs={'class': 'job-list-item__description'})
                    span = cont.find('span')
                    content = span.text
                    company = 'No name'
                    span_salary = li.find('span', attrs={'class': 'public-salary-item'})
                    if span_salary:
                        salary = span_salary.text
                    else:
                        salary='0'
                    comp = li.find('a', attrs={'class': 'mr-2'})

                    img_div = li.find('div', attrs={'class': 'userpic-wrapper userpic-color_2 userpic_xs userpic-transparent userpic--logo'})
                    if img_div:
                        img_src = img_div.img['src']
                    else:
                        img_src = 'https://sourcingsummit.net/sosutech/wp-content/uploads/sites/30/2017/07/djinnix505x235-1.jpg'

                    if comp:
                        company = comp.text

                    jobs.append({'title': title.text, 'img_source': img_src, 'url': domain+href,
                                 'description': content, 'company': company,
                                 'city_id': city, 'language_id': language, 'salary': salary, 'site': "robota"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.webdriver.common.action_chains import ActionChains
import time

def robota(url, city=None, language=None):
    jobs = []
    errors = []
    domain = 'https://robota.ua'

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä–∞–π–≤–µ—Ä–∞ Chrome
    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument('--headless')
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.binary_location = 'chromedriver.exe'
    driver = webdriver.Chrome(options=chrome_options)

    try:
        driver.get(url)

        for i in range(10):
          driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
          time.sleep(2)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞–º–∏

        # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –≤–º—ñ—Å—Ç—É
        time.sleep(5)

        # –û—Ç—Ä–∏–º–∞–Ω–Ω—è HTML-–≤–º—ñ—Å—Ç—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        page_source = driver.page_source


        soup = BS(page_source, 'html.parser')

        # –ü–æ–∏—Å–∫ –±–ª–æ–∫–æ–≤ —Å –≤–∞–∫–∞–Ω—Å–∏—è–º–∏
        job_divs = soup.find_all('alliance-vacancy-card-desktop')
        for job_div in job_divs:
            #print(job_div)
            a = job_div.find('a', class_='card')
            if a:
                href = a['href']
            else:
                href = ''

            title_tag = job_div.find('h2', class_='santa-typo-h3')
            if title_tag:
                title = title_tag.text.strip()
            else:
                title = ''

            spans = job_div.find_all('span', class_='ng-trigger')
            salary = '0'
            company = ''
            for span in spans:
                text = span.text.strip()
                if '‚Ç¥' in text:  # –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∑–∞—Ä–ø–ª–∞—Ç–∞
                    salary = text
                else:
                    company = text
                    break
            # –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ —Ä–∞–±–æ—Ç–∞
            img_div = job_div.find('div', attrs={'class': 'company-logo'})
            img_src = 'https://play-lh.googleusercontent.com/mr-SZKDW5xmXOinA1cQWz6VeQ10BMKS_UfjGpSxrtoRAl9tNe6HPq5ALFCBAQE2Gw8A'
            if img_div:
                img_tag = img_div.find('img')
                if img_tag:
                    img_src = img_tag['src']

            content_divs = job_div.find_all('div', attrs={'class': 'badge'})
            content = ''
            if content_divs:
                for div in content_divs :
                    content += div.text + "."
                content += ".."

            jobs.append({'title': title, 'img_source': img_src, 'url': domain + href,
                         'description': content, 'company': company,
                         'city_id': city, 'language_id': language, 'salary': salary, 'site': "robota"})

    except Exception as e:
        errors.append({'url': url, 'title': str(e)})

    finally:
        # –ó–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        driver.quit()

    return jobs, errors

# url = 'https://robota.ua/zapros/java-junior/kyiv'
# print(url)
# jobs, errors = robota(url)
# print(jobs)
# print(errors)

def jooble(url):
    jobs = []
    errors = []
    if url:
        resp = requests.get(url, headers=headers[randint(0, 2)])
        if resp.status_code == 200:
            soup = BS(resp.content, 'html.parser')
            main_div = soup.find('div', class_='infinite-scroll-component ZbPfXY _serpContentBlock')
            if main_div:
                div_lst = main_div.find_all('div', attrs={'data-test-name': '_jobCard'})

                for div in div_lst:
                    a = div.find('a', class_='hyperlink_appearance_undefined')
                    href = a['href']
                    title = a.text
                    div_info = div.find('div', class_='slQ-DR')
                    salary = '0'
                    p_salary = div_info.find('p')
                    if p_salary:
                        salary = p_salary.text
                    description = div_info('div', class_='PAM72f')#—Ç—É—Ç –∫–∞–∫–æ–π-—Ç–æ –º–∞—Å–∏–≤, –ø–æ –∏–¥–µ–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–∞–∫–æ–≥–æ['div: a: a: spin: ']
                    div_title = div.find('div', class_='L4BhzZ')
                    p_company = div_title.find('p', class_='z6WlhX')
                    company=''
                    if p_company:
                        company = p_company.text
                    img = div_title.find('img')
                    if img:
                        img_src = img['src']
                    else:
                        img_src =  'https://play-lh.googleusercontent.com/JCQ1opom-Kay8f3xVs9VfKmDKsKD3md5uKLJf93gsYAawE6UpzgN_2fALgS0mKOcNw=s256-rw'

                    jobs.append({'title': title, 'img_source': img_src, 'url': href,
                                 'description': description[0].text, 'company': company,
                                  'salary': salary, 'site': "jooble"})
            else:
                errors.append({'url': url, 'title': "Div does not exists"})
        else:
            errors.append({'url': url, 'title': "Page do not response"})

    return jobs, errors

def format_vacancy(job):
    salary = job.get('salary')  # –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–ª—è "salary"
    description = job.get('description', '')  # –û—Ç—Ä–∏–º—É—î–º–æ –æ–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –ø—É—Å—Ç–∏–π —Ä—è–¥–æ–∫
    if salary and salary not in ['0', '']:  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞—Ä–ø–ª–∞—Ç–∏ –Ω–µ–ø—É—Å—Ç–∏–º —á–∏—Å–ª–æ–º
        vacancy_message = f"<b>{job['title']}</b>\n"\
                          f"<b>–ö–æ–º–ø–∞–Ω—ñ—è:</b> {job['company'].strip()}\n" \
                          f"<b>–ó–∞—Ä–ø–ª–∞—Ç–∞:</b> {salary}\n"
    else:
        vacancy_message = f"<b>{job['title']}</b>\n"\
                          f"<b>–ö–æ–º–ø–∞–Ω—ñ—è:</b> {job['company'].strip()}\n"

    if description.strip():  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó –Ω–µ —î –ø—É—Å—Ç–∏–º —Ä—è–¥–∫–æ–º
        vacancy_message += f"<b>–û–ø–∏—Å –≤–∞–∫–∞–Ω—Å—ñ—ó:</b>\n{description.strip()}\n"

    vacancy_message += f"\n–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ –∑–∞ <a href='{job['url']}'>–ø–æ—Å–∏–ª–∞–Ω–Ω—è–º</a>"

    return vacancy_message

class STAGE(Enum):
  START = 0
  NEXT_PARAM_CITY = 1
  NEXT_PARAM_CATEGORY = 2
  NEXT_PARAM_POSITION = 3
  NEXT_PARAM_MIN_SALARY = 4
  NEXT_PARAM_EXPERIENCE = 5
  NEXT_PARAM_LANGUAGE = 6
  END_OF_PROFILE_FILLING = 7
  RECEIVING_VACANCIES = 8
  START_SEARCH = 9
  START_SEARCHING_FOR_NEW_VACANCIES = 10
  CREATE_REQUEST = 11 #–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Ç.
  MY_REQUESTS = 12 #–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å–≤–æ—ó –∑–∞–ø–∏—Ç–∏.
  PRICING = 13 # –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ —Ç–∞—Ä–∏—Ñ–∞–º–∏ —Ç–∞ –æ–ø–ª–∞—Ç–æ—é.
  ABOUT_BOT = 14 #–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –±–æ—Ç–∞.
  OFFER_VACANCY = 15 #–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Å–≤–æ—é –≤–∞–∫–∞–Ω—Å—ñ—é.
  CONTACTS = 15 #–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –∑–Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.


class Request:
  def __init__(self, language='', city='', position='', min_salary=0, experience=EXPERIENCE.DEFAULT_VALUE.value):
    self.language = language
    self.city = city
    self.position = position
    self.min_salary = int(min_salary)
    self.experience = int(experience)

  def __str__(self):
    return (f"Request(Language: {self.language}, City: {self.city}, "
            f"Position: {self.position}, Min Salary: {self.min_salary}, "
            f"Experience: {self.experience})")

  def set_language(self, language):
    self.language = language

  def set_city(self, city):
    self.city = city

  def set_position(self, position):
    self.position = position

  def set_min_salary(self, min_salary):
    self.min_salary = int(min_salary)

  def set_experience(self, experience):
    self.experience = int(experience)

def submit_vacancy(jobs, chat_id):
  for job in jobs:
    print(job)
    try:
        #print("job['img_source'] = ", job['img_source'])
        bot.send_photo(chat_id, job['img_source'], caption=format_vacancy(job), parse_mode='HTML')
    except ApiTelegramException as e:
        print(f"An error occurred while sending the photo: {e}. URL: {job['img_source']}. Skip vacancy.")


def start_seach_and_send_workua_vacancy(request:Request, chat_id, on_the_background:bool = False):
    if not on_the_background: days = 125 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å
    else: days = 122 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å
    url_work = build_url_workua(
            language=request.language,
            city=request.city, #–¢–£–¢ –ü–û–•–û–î–£ –£–ö–†–ê–á–ù–°–¨–ö–û–Æ –ù–ï –ú–û–ñ–ù–ê, –¢–†–ï–ë–ê –í–ò–ü–†–ê–í–ò–¢–ò
            position=request.position,
            min_salary=request.min_salary,
            experience=request.experience,
            days=date
    )
    print("WORKUA URL: ", url_work)
    jobs_work, errors_work = work(url_work)
    print(jobs_work)
    print(errors_work)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_work, "workua")
      submit_vacancy(jobs_work, chat_id)
    else:
      return jobs_work, errors_work

def start_seach_and_send_dou_vacancy(request:Request, chat_id, on_the_background:bool = False):
    url_dou = build_url_dou(search=request.language, position=request.position, city=request.city, exp=request.experience ) #–≤ –¥–æ—É –º–æ–∂–Ω–∞ —Å–∫—Ä–∞–ø–∏—Ç—å —ñ –ø–æ 0-1 —ñ –ø–æ 1-3, —Ç–æ–∂–µ –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É
    print("DOU URL: ", url_dou)
    jobs_dou, errors_dou = dou(url_dou)
    print(jobs_dou)
    print(errors_dou)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_dou, "dou")
      submit_vacancy(jobs_dou, chat_id)
    else:
      return jobs_dou, errors_dou

def start_seach_and_send_djinni_vacancy(request:Request, chat_id, on_the_background:bool = False):
    url_djinni = build_url_djinni(
      #all_keywords=request.language,
      primary_keyword=request.language,
      region="UKR",
      location=request.city,
      exp_level=request.experience,
      exp_rank=request.position,
      salary=convert_uah_to_usd_for_djinni(request.min_salary, 39.1),
      keywords=request.language
    )
    print("DJINNI URL: ", url_djinni)
    jobs_djinni, errors_djinni = djinni(url_djinni)
    add_vacancies_to_db(request, chat_id, jobs_djinni, "djinni")
    print(jobs_djinni)
    print(errors_djinni)
    if not on_the_background:
      submit_vacancy(jobs_djinni, chat_id)
    else:
      return jobs_djinni, errors_djinni

def start_seach_and_send_robota_vacancy(request:Request, chat_id, on_the_background:bool = False):
    url_robota=build_url_robota(language=request.language, city=request.city, position=request.position, salary = request.min_salary, experience=request.experience)
    print("ROBOTA URL: ", url_robota)
    jobs_rabota, errors_robota = robota(url_robota)
    print(jobs_rabota)
    print(errors_robota)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_rabota, "robota")
      submit_vacancy(jobs_rabota, chat_id)
    else:
      return jobs_rabota, errors_robota

def start_seach_and_send_jooble_vacancy(request:Request, chat_id, on_the_background:bool = False):
    if not on_the_background: date = 3 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é –Ω–µ–¥—ñ–ª–ª—é
    else: date = 8 #–≤–∞–∫–∞–Ω—Å—ñ—ó –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å
    url_jooble = build_url_jooble(date=date,
                                  rgns=request.city,
                                  salaryMin=request.min_salary,
                                  ukw=request.position + ' ' + request.language,
                                  workExp=request.experience
                                 )
    print("JOOBLE URL: ", url_jooble)
    jobs_jooble, errors_jooble = jooble(url_jooble)
    print(jobs_jooble)
    print(errors_jooble)
    if not on_the_background:
      add_vacancies_to_db(request, chat_id, jobs_jooble, "jooble")
      submit_vacancy(jobs_jooble, chat_id)
    else:
      return jobs_jooble, errors_jooble

def check_db_has_such_vacancy(request_id, site, title, company):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –≤–∞–∫–∞–Ω—Å–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    check_query = """
        SELECT COUNT(*) FROM vacancies
        WHERE request_id = %s AND site = %s AND title = %s AND company = %s
        """
    check_params = (request_id, site, title, company)
    check_result = execute_query(check_query, check_params)
    if check_result[0][0] == 0:
      return False
    else:
      return True

def add_NEW_vacancy_to_db(request_id, site, title, company, description):
    insert_query = """
                    INSERT INTO vacancies (request_id, site, title, company, description) VALUES(%s, %s, %s, %s, %s)
                    """
    insert_params = (request_id, site, title, company, description)
    insert_result = execute_query(insert_query, insert_params)
    return insert_result

def add_vacancies_to_db(request: Request, chat_id, vacancies, site):
    query = """
        SELECT request_id FROM requests
        WHERE chat_id = %s AND technology = %s AND position = %s AND city = %s AND min_salary = %s AND experience = %s
        """
    params = (chat_id, request.language, request.position, request.city, request.min_salary, request.experience)
    result = execute_query(query, params)

    if result:
        for vacancy in vacancies:#[:5]:  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –≤–∞–∫–∞–Ω—Å–∏–π. –ù–ï–¢. –ü–û–ö–ê –ß–¢–û –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –í–°–ï –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –¥–±, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ –±—ã–ª–æ –ø—Ä–æ–±–ª–µ–º
            db_has_such_vacancy = check_db_has_such_vacancy(result[0][0], site, vacancy['title'], vacancy['company'].strip())
            # –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            if db_has_such_vacancy == False:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∞–∫–∞–Ω—Å–∏—è –≤ –±–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                insert_result = add_NEW_vacancy_to_db(result[0][0], site, vacancy['title'], vacancy['company'].strip(), vacancy.get('description', ''))
                print("–í–∞–∫–∞–Ω—Å–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞:", insert_result)
            else:
                print("–í–∞–∫–∞–Ω—Å–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")

!pip install schedule > null

import schedule
import time
import threading
from itertools import chain
keep_running = True

def get_requests_from_db():
    query = """
        SELECT * FROM requests
        """
    return execute_query(query)

print( get_requests_from_db())

def job(chat_id): #–¢—É—Ç –∑–º—ñ–Ω–∏–º–æ —Ñ—É–Ω–∫—Ü—ñ—é, —â–æ–± –≤–æ–Ω–∞ —Å–∫—Ä–∞–ø–∏–ª–∞ –¥–∞–Ω–Ω—ñ –∑ —Å–∞–π—Ç—É (—è–∫—â–æ –º–æ–∂–ª–∏–≤–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏, —Ç–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –ø–æ –º–∞–∫—Å–∏–º—É–º—É) —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è–ª–∞ —á–∏ —î —Ç–∞–∫—ñ –≤–∞–∫–∞–Ω—Å—ñ—ó –≤ –±–∞–∑—ñ –¥–∞–Ω–Ω–∏—Ö —ñ –≤—ñ–¥—Å—ñ—é–≤–∞–ª–∞ —Ç–∞–∫—ñ
    print("Start working on background")
    requests_from_db = get_requests_from_db()
    for request_item in requests_from_db:
      request_from_db = Request(language=request_item[2], city=request_item[4], position=request_item[3], min_salary=request_item[5], experience=request_item[6])
      print(request_from_db)
      print("Start searching on background")
      jobs_work, errors_work = start_seach_and_send_workua_vacancy(request_from_db, 0, on_the_background = True)
      # jobs_dou, errors_dou = start_seach_and_send_dou_vacancy(request_from_db, 0, on_the_background = True)
      # jobs_djinni, errors_djinni = start_seach_and_send_djinni_vacancy(request_from_db, 0, on_the_background = True)
      # jobs_rabota, errors_robot = start_seach_and_send_robota_vacancy(request_from_db, 0, on_the_background = True)
      # jobs_jooble, errors_jooble = start_seach_and_send_jooble_vacancy(request_from_db, 0, on_the_background = True)
      print("End searching on background")

      vacancies = list(chain(jobs_work))#, jobs_dou, jobs_djinni, jobs_rabota, jobs_jooble))
      #vacancies = [jobs_work]#, jobs_dou, jobs_djinni, jobs_rabota, jobs_jooble]
      print("Start checking finding vacancies")
      for vacancy in vacancies:
        print("vacancy: ", vacancy)
        if check_db_has_such_vacancy(request_item[0], vacancy['site'], vacancy['title'], vacancy['company'].strip()) == False:
          print("Find new vacancy! Add to db and submit to chat")
          insert_result = add_NEW_vacancy_to_db(request_item[0], vacancy['site'], vacancy['title'], vacancy['company'].strip(), vacancy.get('description', ''))
          print("–í–∞–∫–∞–Ω—Å–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞:", insert_result)
          submit_vacancy([vacancy], int(request_item[1])) #request_item[1] - —Ü–µ chat_id
        else:
          print("This vacancy is already in the database")
          #bot.send_message(request_item[1], "Nothing new. I'm working...")
      print("End checking finding vacancies")

#job(869704769)

def start_scheduler():
    global keep_running
    keep_running = True

def stop_scheduler():
    global keep_running
    keep_running = False

def run_scheduler(chat_id):
    schedule.every(1).minutes.do(lambda: job(chat_id))
    global keep_running
    print("start run_scheduler. keep_running = ", keep_running)
    while keep_running:
        schedule.run_pending()
        time.sleep(1)

def get_subscription_info(chat_id):
    result = execute_query("SELECT paid_subscription FROM users WHERE chat_id = %s", (chat_id,))
    if result:
        subscription_level = result[0][0]
        if subscription_level == 0:
            return "–í–∏ —â–µ –Ω–µ –æ–±—Ä–∞–ª–∏ –∂–æ–¥–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ—É."
        elif subscription_level == 1:
            return "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: üî¥ –ï–∫–æ–Ω–æ–º."
        elif subscription_level == 2:
            return "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç."
        elif subscription_level == 3:
            return "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: üü¢ –ë—ñ–∑–Ω–µ—Å."
    else:
        return "–í–∏ —â–µ –Ω–µ –æ–±—Ä–∞–ª–∏ –∂–æ–¥–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ—É."

from telebot import types
from telebot.apihelper import ApiTelegramException
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
import threading
from datetime import datetime
from dateutil.relativedelta import relativedelta

TOKEN = '7161535193:AAG2EDGz-thMU4zFHRS0ZC3OoqnmGr9L79E'


bot = telebot.TeleBot(TOKEN)
request = Request()
stage = STAGE.START
print(stage)

def get_end_subscription_date():
    current_date = datetime.now().date()
    return current_date + relativedelta(months=1)

@bot.message_handler(commands=['pay1'])
def pay1_command(message):
    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç–∏"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç–∏", callback_data='pay1_payment'))

    # –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–Ω–æ–ø–∫–æ—é
    bot.send_message(message.chat.id, """
    üî¥ –ï–∫–æ–Ω–æ–º
    –°—Ç–≤–æ—Ä—é–π—Ç–µ –¥–æ –¥–≤–æ—Ö(2) –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å.
    –¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è.
    –û–ø–ª–∞—á—É—é—á–∏ –í–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –£–º–æ–≤–∞–º–∏ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è.
    """, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('pay1_payment'))
def pay1_payment_callback(call):
    end_date_subscription = get_end_subscription_date()
    execute_query("UPDATE users SET paid_subscription = 1, max_num_of_request = 2, end_date_subscription = %s WHERE chat_id = %s", (end_date_subscription, call.from_user.id))
    bot.send_message(call.message.chat.id, "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –ï–∫–æ–Ω–æ–º.")

@bot.message_handler(commands=['pay2'])
def pay2_command(message):
    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç–∏"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç–∏", callback_data='pay2_payment'))
    bot.send_message(message.chat.id, """
    üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç
    –°—Ç–≤–æ—Ä—é–π—Ç–µ –¥–æ —á–æ—Ç–∏—Ä—å–æ—Ö(4) –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å.
    –¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è.
    –û–ø–ª–∞—á—É—é—á–∏ –í–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –£–º–æ–≤–∞–º–∏ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è.
    """, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('pay2_payment'))
def pay2_payment_callback(call):
    end_date_subscription = get_end_subscription_date()
    execute_query("UPDATE users SET paid_subscription = 2, max_num_of_request = 4, end_date_subscription = %s WHERE chat_id = %s", (end_date_subscription, call.from_user.id))
    bot.send_message(call.message.chat.id, "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –°—Ç–∞–Ω–¥–∞—Ä—Ç.")

@bot.message_handler(commands=['pay3'])
def pay3_command(message):
    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç–∏"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç–∏", callback_data='pay3_payment'))
    bot.send_message(message.chat.id, """
    üü¢ –ë—ñ–∑–Ω–µ—Å
    –°—Ç–≤–æ—Ä—é–π—Ç–µ –¥–æ –¥–µ—Å—è—Ç–∏(10) –ø–æ—à—É–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å.
    –¢–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ —Ç—Ä–∏–≤–∞—î –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è.
    –û–ø–ª–∞—á—É—é—á–∏ –í–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –£–º–æ–≤–∞–º–∏ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è.
    """, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('pay3_payment'))
def pay3_payment_callback(call):
    end_date_subscription = get_end_subscription_date()
    execute_query("UPDATE users SET paid_subscription = 3, max_num_of_request = 10, end_date_subscription = %s WHERE chat_id = %s", (end_date_subscription, call.from_user.id))
    bot.send_message(call.message.chat.id, "–í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –ë—ñ–∑–Ω–µ—Å.")

@bot.message_handler(commands=['start'])
def start(message):
    global stage
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    # btn1 = types.KeyboardButton("–ü–æ—á–∞—Ç–∏ –ø–æ—à—É–∫ —Ä–æ–±–æ—Ç–∏")
    # markup.add(btn1)
    bot.send_message(message.from_user.id, "üëã –ü—Ä–∏–≤—ñ—Ç! –í–∞—Å –≤—ñ—Ç–∞—î –±–æ—Ç –∑ –ø–æ—à—É–∫—É —Ä–æ–±–æ—Ç–∏!", reply_markup=markup)
    show_main_menu(message.from_user.id)
    stage = STAGE.START

def generate_keyboard(options):
    markup = ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
    for option in options:
        markup.add(KeyboardButton(option))
    return markup

cities = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "remote", "Kyiv", "Vinnytsia", "Dnipro", "Ivano-Frankivsk", "Zhytomyr", "Zaporizhzhia", "Lviv", "Mykolaiv", "Odesa", "Ternopil", "Kharkiv", "Khmelnytskyi", "Cherkasy", "Chernihiv", "Chernivtsi", "Uzhhorod"]
positions = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "Trainee","Intern" , "Junior", "Middle", "Senior", "Team Lead", "Chief of", "Head of"]

categories = ["–†–æ–∑—Ä–æ–±–∫–∞", "–¢–µ—Ö–Ω—ñ—á–Ω—ñ", "–ù–µ—Ç–µ—Ö–Ω—ñ—á–Ω—ñ"]

programming_languages = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "JavaScript", "Front-End", "Fullstack", "Java", "C#", ".NET", "Python", "PHP", "Node.js", "iOS", "Android", "React Native", "C", "C++", "Embedded", "Flutter", "Golang", "Ruby", "Scala", "Salesforce", "Rust", "Elixir", "Kotlin", "ERP Systems"]
technical_specialties = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "QA Manual", "QA Automation", "Design", "2D/3D Artist", "Illustrator", "Gamedev", "Project Manager", "Product Manager", "Product Owner", "Delivery Manager", "Scrum Master", "Agile Coach", "Architect", "CTO", "DevOps", "Security", "Sysadmin", "Business Analyst", "Data Science", "Data Analyst", "Data Engineer", "SQL", "DBA", "Technical Writing"]
nontechnical_specialties = ["–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", "Marketing", "Sales", "Lead Generation", "SEO", "HR Recruiter", "Customer Support", "Technical Support", "Head", "Chief", "Finances"]

def show_create_request_menu(user_id):
    bot.send_message(user_id, "–û–±–µ—Ä—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=generate_keyboard(["–ö–∞—Ç–µ–≥–æ—Ä—ñ—è", "–ú—ñ—Å—Ç–æ", "–ü–æ–∑–∏—Ü—ñ—è", "–î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏", "–ó–∞—Ä–ø–ª–∞—Ç–∞", "–ü–æ—á–∞—Ç–∏ –ø–æ—à—É–∫!"]))

# def check_and_new_add_user_to_db(chat_id):
#     result = execute_query(f"SELECT * FROM users WHERE chat_id = {chat_id}")
#     if not result:
#         execute_query(f"INSERT INTO users (chat_id, paid_subscription) VALUES ({chat_id}, 0, 1, 1);")

def check_and_new_add_user_to_db(chat_id):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º chat_id
    result = execute_query(f"SELECT * FROM users WHERE chat_id = {chat_id}")
    if not result:
      # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
      execute_query(f"INSERT INTO users (chat_id, paid_subscription, max_num_of_request, num_of_used_request) VALUES ({chat_id}, 0, 2, 0);")


    # else:
    #     # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ num_of_used_request –∏ max_num_of_request
    #     user_info = execute_query(f"SELECT num_of_used_request, max_num_of_request FROM users WHERE chat_id = {chat_id}")
    #     if user_info:
    #         num_of_used_request, max_num_of_request = user_info[0]
    #         # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ num_of_used_request max_num_of_request
    #         if num_of_used_request >= max_num_of_request:
    #             # –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç, –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    #             bot.send_message(message.from_user.id, "–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø–æ–¥–ø–∏—Å–∫–æ–π.")
    #         else:
    #             # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ num_of_used_request –Ω–∞ 1
    #             execute_query(f"UPDATE users SET num_of_used_request = num_of_used_request + 1 WHERE chat_id = {chat_id}")


def add_request_to_db(chat_id, technology, position, city, min_salary, experience):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    existing_request = execute_query("SELECT * FROM requests WHERE chat_id = %s AND technology = %s AND position = %s AND city = %s AND min_salary = %s AND experience = %s", (chat_id, technology, position, city, min_salary, experience))
    if not existing_request:
                execute_query(f"UPDATE users SET num_of_used_request = num_of_used_request + 1 WHERE chat_id = {chat_id}")
                execute_query("INSERT INTO requests (chat_id, technology, position, city, min_salary, experience) VALUES (%s, %s, %s, %s, %s, %s)", (chat_id, technology, position, city, min_salary, experience))
    else:
      bot.send_message(chat_id, "–¢–∞–∫–∏–π –∑–∞–ø–∏—Ç –≤–∂–µ —ñ—Å–Ω—É—î.")

def show_user_requests(chat_id):
    # –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∑–∞ –π–æ–≥–æ chat_id
    query = "SELECT * FROM requests WHERE chat_id = %s"
    params = (chat_id,)
    user_requests = execute_query(query, params)

    if user_requests:
        # –Ø–∫—â–æ —î –∑–∞–ø–∏—Ç–∏, –≤–∏–≤–æ–¥–∏–º–æ —ó—Ö —É –±–æ—Ç—ñ
         for i, req in enumerate(user_requests, start=1):
            request_text = f"""
            –ù–æ–º–µ—Ä –∑–∞–ø–∏—Ç—É : {i}
            –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: {req[1]}
            –ü–æ–∑–∏—Ü—ñ—è: {req[2]}
            –ú—ñ—Å—Ç–æ: {req[3]}
            –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –∑–∞—Ä–æ–±—ñ—Ç–Ω–∞ –ø–ª–∞—Ç–∞: {req[4]}
            –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏: {req[5]}
            """
            bot.send_message(chat_id, request_text)

    else:
        bot.send_message(chat_id, "–í–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–∏–ª–∏ –∂–æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É.")


@bot.message_handler(content_types=['text'])
def handle_text(message):
    global stage
    threading.Thread(target=check_and_new_add_user_to_db, args=(message.from_user.id, )).start()

    if message.text == "–ü–æ—á–∞—Ç–∏ –ø–æ—à—É–∫!" and stage==STAGE.CREATE_REQUEST:
        if request.language == "":
          bot.send_message(message.from_user.id, "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–ª—è –ø–æ—à—É–∫—É (–º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è)!")
          bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:", reply_markup=generate_keyboard(categories))
          stage = STAGE.NEXT_PARAM_CATEGORY
        else:
          stage = STAGE.START_SEARCH
    if stage == STAGE.START:
        show_main_menu(message.from_user.id)
        if message.text == "–ú–æ—ó –∑–∞–ø–∏—Ç–∏":
            stage = STAGE.MY_REQUESTS
            show_user_requests(message.from_user.id)
            stage = STAGE.START
        elif message.text == "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç":
            show_create_request_menu(message.from_user.id)
            stage = STAGE.CREATE_REQUEST
        elif message.text == "–¢–∞—Ä–∏—Ñ–∏ —Ç–∞ –æ–ø–ª–∞—Ç–∞":
           subscription_info = get_subscription_info(message.from_user.id)
           bot.send_message(message.from_user.id, f"""
                        –í–∞—à –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: {subscription_info}

  –•–æ—á–µ—Ç–µ –º–∞—Ç–∏ –±—ñ–ª—å—à–µ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π —É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ –Ω–∞—à–æ–≥–æ –±–æ—Ç–∞? –û–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –∑ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–∞—Ä–∏—Ñ—ñ–≤:

  üî¥ –ï–∫–æ–Ω–æ–º
  - –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –¥–æ –¥–≤–æ—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å
  - –¶—ñ–Ω–∞: $1 –Ω–∞ –º—ñ—Å—è—Ü—å
  - –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /pay1

  üü† –°—Ç–∞–Ω–¥–∞—Ä—Ç
  - –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –¥–æ —á–æ—Ç–∏—Ä—å–æ—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å
  - –¶—ñ–Ω–∞: $2 –Ω–∞ –º—ñ—Å—è—Ü—å
  - –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /pay2

  üü¢ –ë—ñ–∑–Ω–µ—Å
  - –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –¥–æ –¥–µ—Å—è—Ç–∏ –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –ø–æ—à—É–∫—É –≤–∞–∫–∞–Ω—Å—ñ–π –Ω–∞ –º—ñ—Å—è—Ü—å
  - –¶—ñ–Ω–∞: $5 –Ω–∞ –º—ñ—Å—è—Ü—å
  - –î–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /pay3

  –û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –≤–∞—Å —Ç–∞—Ä–∏—Ñ, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –±—ñ–ª—å—à–æ–≥–æ –æ–±—Å—è–≥—É –≤–∞–∫–∞–Ω—Å—ñ–π —Ç–∞ —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π.
  """)
           stage = STAGE.PRICING
                # –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–∞—Ä–∏—Ñ–∏ —Ç–∞ –æ–ø–ª–∞—Ç—É
        elif message.text == "–ü—Ä–æ –±–æ—Ç":
            stage = STAGE.ABOUT_BOT
                # –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–æ—Ç–∞
        elif message.text == "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Å–≤–æ—é –≤–∞–∫–∞–Ω—Å—ñ—é":
            stage = STAGE.OFFER_VACANCY
                # –í–∏–∫–æ–Ω–∞—Ç–∏ –¥—ñ—ó –¥–ª—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –≤–∞–∫–∞–Ω—Å—ñ—ó
        elif message.text == "–ö–æ–Ω—Ç–∞–∫—Ç–∏":
            stage = STAGE.CONTACTS
        # –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
    elif stage == STAGE.CREATE_REQUEST:
        if message.text == "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è":
            bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:", reply_markup=generate_keyboard(categories))
            stage = STAGE.NEXT_PARAM_CATEGORY
        elif message.text == "–ú—ñ—Å—Ç–æ":
            bot.send_message(message.from_user.id, "–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=generate_keyboard(cities))
            stage = STAGE.NEXT_PARAM_CITY
        elif message.text == "–ü–æ–∑–∏—Ü—ñ—è":
            bot.send_message(message.from_user.id, "–í–∏–±–µ—Ä—ñ—Ç—å –≤–∞—à—É –ø–æ–∑–∏—Ü—ñ—é:", reply_markup=generate_keyboard(positions))
            stage = STAGE.NEXT_PARAM_POSITION
        elif message.text == "–î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏":
            bot.send_message(message.from_user.id, "–í–∫–∞–∂—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É:")
            stage = STAGE.NEXT_PARAM_EXPERIENCE
        elif message.text == "–ó–∞—Ä–ø–ª–∞—Ç–∞":
            bot.send_message(message.from_user.id, "–í–∫–∞–∂—ñ—Ç—å –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É –∑–∞—Ä–ø–ª–∞—Ç—É (–≥—Ä–Ω):")
            stage = STAGE.NEXT_PARAM_MIN_SALARY
    elif stage == STAGE.NEXT_PARAM_CATEGORY:
        if message.text == "–†–æ–∑—Ä–æ–±–∫–∞":
            bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=generate_keyboard(programming_languages))
            stage = STAGE.NEXT_PARAM_LANGUAGE
        elif message.text == "–¢–µ—Ö–Ω—ñ—á–Ω—ñ":
            bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ—á–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=generate_keyboard(technical_specialties))
            stage = STAGE.NEXT_PARAM_LANGUAGE
        elif message.text == "–ù–µ—Ç–µ—Ö–Ω—ñ—á–Ω—ñ":
            bot.send_message(message.from_user.id, "–û–±–µ—Ä—ñ—Ç—å –Ω–µ—Ç–µ—Ö–Ω—ñ—á–Ω—É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –ø–æ—à—É–∫—É:", reply_markup=generate_keyboard(nontechnical_specialties))
            stage = STAGE.NEXT_PARAM_LANGUAGE

    elif stage == STAGE.NEXT_PARAM_LANGUAGE:
        if message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é":
            stage = STAGE.START
            show_main_menu(message.from_user.id)
        else:
            request.set_language(message.text)
            stage = STAGE.CREATE_REQUEST
            show_create_request_menu(message.from_user.id)
    elif stage == STAGE.NEXT_PARAM_CITY:
        if message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é":
            stage = STAGE.START
            show_main_menu(message.from_user.id)
        else:
            request.set_city(message.text)
            stage = STAGE.CREATE_REQUEST
            show_create_request_menu(message.from_user.id)
    elif stage == STAGE.NEXT_PARAM_POSITION:
        if message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é":
            stage = STAGE.START
            show_main_menu(message.from_user.id)
        else:
            request.set_position(message.text)
            stage = STAGE.CREATE_REQUEST
            show_create_request_menu(message.from_user.id)
    elif stage == STAGE.NEXT_PARAM_EXPERIENCE:
        if message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é":
            stage = STAGE.START
            show_main_menu(message.from_user.id)
        else:
            request.set_experience(message.text)
            stage = STAGE.CREATE_REQUEST
            show_create_request_menu(message.from_user.id)
    elif stage == STAGE.NEXT_PARAM_MIN_SALARY:
        if message.text == "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é":
            stage = STAGE.START
            show_main_menu(message.from_user.id)
        else:
            request.set_min_salary(message.text)
            stage = STAGE.CREATE_REQUEST
            show_create_request_menu(message.from_user.id)

    elif stage == STAGE.START_SEARCH:
        show_main_menu(message.from_user.id)
        stop_scheduler()
        threads = []
        #threads.append(threading.Thread(target=start_seach_and_send_workua_vacancy, args=(request, message.from_user.id)))
        #threads.append(threading.Thread(target=start_seach_and_send_dou_vacancy, args=(request, message.from_user.id)))
        #threads.append(threading.Thread(target=start_seach_and_send_djinni_vacancy, args=(request, message.from_user.id)))
        #threads.append(threading.Thread(target=start_seach_and_send_robota_vacancy, args=(request, message.from_user.id)))
        threads.append(threading.Thread(target=start_seach_and_send_jooble_vacancy, args=(request, message.from_user.id)))

        for thread in threads:
            thread.start()

        for thread in threads:
            thread.join()
        #stage = STAGE.START_SEARCHING_FOR_NEW_VACANCIES # —Ç–∞–∫ –Ω–µ –º–æ–∂–Ω–∞ –±—É–¥–µ –ø–æ—Ç—ñ–º –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–æ—à—É–∫—É, —Ç—Ä–µ–±–∞ —â–µ –ø–æ–¥—É–º–∞—Ç–∏
        stage = STAGE.START

        start_scheduler()
        threading.Thread(target=run_scheduler, args=(message.from_user.id, )).start()
        #–ü—Ä–∏–¥—É–º–∞—Ç—å —á—Ç–æ-—Ç–æ, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–ª–æ—Å—å
        threading.Thread(target=add_request_to_db, args=(message.from_user.id,request.language, request.position, request.city, request.min_salary, request.experience)).start()
    else:
        bot.send_message(message.from_user.id, "–°–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ —ñ–Ω—à—É –∫–æ–º–∞–Ω–¥—É. –í–≤–µ–¥—ñ—Ç—å /start.") #TODO: –∫—É–¥–∏—Å—å –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏, —Ü—è —á–∞—Å—Ç–∏–Ω–∞ –Ω–µ –ø—Ä–∞—Ü—é—î



# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
def show_main_menu(user_id):
    markup = types.ReplyKeyboardMarkup(row_width=2)
    item1 = types.KeyboardButton("–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç")
    item2 = types.KeyboardButton("–ú–æ—ó –∑–∞–ø–∏—Ç–∏")
    item3 = types.KeyboardButton("–¢–∞—Ä–∏—Ñ–∏ —Ç–∞ –æ–ø–ª–∞—Ç–∞")
    item4 = types.KeyboardButton("–ü—Ä–æ –±–æ—Ç")
    item5 = types.KeyboardButton("–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Å–≤–æ—é –≤–∞–∫–∞–Ω—Å—ñ—é")
    item6 = types.KeyboardButton("–ö–æ–Ω—Ç–∞–∫—Ç–∏")
    markup.add(item1, item2, item3, item4, item5, item6)
    #bot.send_message(user_id, "–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:", reply_markup=markup)


bot.polling(none_stop=True, interval=0)

stop_scheduler()

# –ó–ê–î–ê–ß–Ü:
# 1. –ó–∞–ª–∏—Ç—å –Ω–∞ –≥–∏—Ç—Ö–∞–± —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é
# 2. –ó—Ä–æ–±–∏—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–≤–æ—ó—Ö –≤–∞–∫–∞–Ω—Å—ñ–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥ –≤–∞–∫–∞–Ω—Å—ñ—î—é
# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∫–≤–µ—Å—Ç—ñ–≤, —â–æ–± –±—ñ–ª—å—à–µ –Ω—ñ–∂ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–µ –º–æ–∂–Ω–∞ –±—É–ª–æ –∑—Ä–æ–±–∏—Ç–∏
# 4. –í —Ü—ñ–ª–æ–º—É –∑—Ä–æ–±–∏—Ç–∏ –±—ñ–ª—å—à –≥–∞—Ä–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
# 5. –ó—Ä–æ–±–∏—Ç–∏ —à–æ–± –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ñ–æ–Ω–æ–≤–∏–π –ø–æ—à—É–∫ –≤–∞–∫–∞–Ω—Å—ñ–π –∑–∞–ø—É—Å–∫–∞–≤—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∞ –Ω–µ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –º–∏ –≤—Ä—É—á–Ω—É –¥–æ–¥–∞–ª–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Ç
# –ó–†–û–ë–õ–ï–ù–û 6. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —è–∫ —ñ–Ω—à—ñ —Å–∞–π—Ç–∏ –ø—Ä–∞—Ü—é—é—Ç—å –∑ "–°++", "–°#", —è–∫—â–æ —î –ø—Ä–æ–±–ª–µ–º–∏ - —à–≤–∏–¥–∫–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–æ workua
# 7. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ PyCharm —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —è–∫ —à–≤–∏–¥–∫–æ –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –∑–∞–ø–∏—Ç–∞–º–∏ –¥–æ –ë–î
# 8. –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è robota —ñ djini
# 9. –ó—Ä–æ–±–∏—Ç–∏, —â–æ–± –≤–∏–≤–æ–¥–∏–ª–æ—Å—å –ø–æ 10 –∑–∞–ø–∏—Ç—ñ–≤, –∞ —ñ–Ω—à—ñ —â–æ–± –ø—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –©–ï
# 10. –ó—Ä–æ–±–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–Ω–∞–ª –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –≤–∞–∫–∞–Ω—Å—ñ–π, —è–∫—ñ —î –ª–∏—à–µ –≤ –±–æ—Ç—ñ
# 11. –î–æ–¥–∞—Ç–∏ –∞–¥–º—ñ–Ω–∞, –º–∞–±—É—Ç—å –∑—Ä–æ–±–∏—Ç–∏ –¥–ª—è –Ω—å–æ–≥–æ —Ç—Ä–æ—Ö–∏ —ñ–Ω—à–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å


# . –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥—É, —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª–∞—Å–∏, —â–æ–± –≤—Å–µ –≥–∞—Ä–Ω–æ –≤–∏–≥–ª—è–¥–∞–ª–æ - –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞ –±—É–¥—å —è–∫–æ–º—É –µ—Ç–∞–ø—ñ, –±–∞–∂–∞–Ω–æ —è–∫–æ–º–æ–≥–∞ —Ä–∞–Ω—ñ—à–µ
# . –ú–æ–∂–ª–∏–≤–æ —â–µ –ø–æ–¥—É–º–∞—Ç–∏ –∑ –ø—Ä–∏–≤–æ–¥—É –æ–ø–ª–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ—ñ–≤ –≥—Ä–æ—à–∏–º–∞
# . –ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ —Å–∏—Å—Ç–µ–º—É (optional), –∞–ª–µ –±–∞–∂–∞–Ω–æ